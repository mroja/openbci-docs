<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>obci.control.launcher.obci_experiment &#8212; openbci 2.0.0-0 documentation</title>
    
    <link rel="stylesheet" href="../../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../',
        VERSION:     '2.0.0-0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <link rel="top" title="openbci 2.0.0-0 documentation" href="../../../../index.html" />
    <link rel="up" title="Module code" href="../../../index.html" />
   
  <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for obci.control.launcher.obci_experiment</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/python3</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">io</span>

<span class="kn">import</span> <span class="nn">zmq</span>

<span class="kn">from</span> <span class="nn">obci.control.common.message</span> <span class="k">import</span> <span class="n">send_msg</span><span class="p">,</span> <span class="n">PollingObject</span>
<span class="kn">import</span> <span class="nn">obci.control.common.net_tools</span> <span class="k">as</span> <span class="nn">net</span>
<span class="kn">import</span> <span class="nn">obci.control.common.obci_control_settings</span> <span class="k">as</span> <span class="nn">settings</span>
<span class="kn">from</span> <span class="nn">obci.control.peer.peer_config_serializer</span> <span class="k">import</span> <span class="n">PeerConfigSerializerJSON</span>

<span class="kn">from</span> <span class="nn">obci.control.launcher.obci_control_peer</span> <span class="k">import</span> <span class="n">OBCIControlPeer</span><span class="p">,</span> <span class="n">basic_arg_parser</span>
<span class="kn">from</span> <span class="nn">.subprocess_monitor</span> <span class="k">import</span> <span class="n">SubprocessMonitor</span><span class="p">,</span> <span class="n">TimeoutDescription</span><span class="p">,</span> <span class="n">NO_STDIO</span>
<span class="kn">from</span> <span class="nn">obci.control.launcher.obci_control_peer</span> <span class="k">import</span> <span class="n">RegistrationDescription</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">subprocess_monitor</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">launch_file_parser</span>
<span class="kn">from</span> <span class="nn">.launch_file_serializer</span> <span class="k">import</span> <span class="n">serialize_scenario_json</span>
<span class="kn">import</span> <span class="nn">obci.control.launcher.launcher_tools</span> <span class="k">as</span> <span class="nn">launcher_tools</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">system_config</span>

<span class="kn">import</span> <span class="nn">obci.control.peer.peer_cmd</span> <span class="k">as</span> <span class="nn">peer_cmd</span>
<span class="kn">from</span> <span class="nn">obci.utils.openbci_logging</span> <span class="k">import</span> <span class="n">log_crash</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">twisted_tcp_handling</span>

<span class="n">REGISTER_TIMEOUT</span> <span class="o">=</span> <span class="mi">25</span>


<div class="viewcode-block" id="OBCIExperiment"><a class="viewcode-back" href="../../../../apidoc/obci.control.launcher.html#obci.control.launcher.obci_experiment.OBCIExperiment">[docs]</a><span class="k">class</span> <span class="nc">OBCIExperiment</span><span class="p">(</span><span class="n">OBCIControlPeer</span><span class="p">):</span>

    <span class="n">msg_handlers</span> <span class="o">=</span> <span class="n">OBCIControlPeer</span><span class="o">.</span><span class="n">msg_handlers</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="nd">@log_crash</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sandbox_dir</span><span class="p">,</span> <span class="n">launch_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">source_addresses</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">source_pub_addresses</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">rep_addresses</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">pub_addresses</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">name</span><span class="o">=</span><span class="s1">&#39;obci_experiment&#39;</span><span class="p">,</span>
                 <span class="n">current_ip</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">launch</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">overwrites</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="c1"># TODO TODO TODO !!!!</span>
        <span class="c1"># cleaner subclassing of obci_control_peer!!!</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source_pub_addresses</span> <span class="o">=</span> <span class="n">source_pub_addresses</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">launch_file</span> <span class="o">=</span> <span class="n">launcher_tools</span><span class="o">.</span><span class="n">obci_root_relative</span><span class="p">(</span><span class="n">launch_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">origin_machine</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">poller</span> <span class="o">=</span> <span class="n">PollingObject</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_ip</span> <span class="o">=</span> <span class="n">current_ip</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nearby_machines</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">DNS</span><span class="p">()</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">OBCIExperiment</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span>
            <span class="n">source_addresses</span><span class="p">,</span>
            <span class="n">rep_addresses</span><span class="p">,</span>
            <span class="n">pub_addresses</span><span class="p">,</span>
            <span class="n">name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; on &#39;</span> <span class="o">+</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sandbox_dir</span> <span class="o">=</span> <span class="n">sandbox_dir</span> <span class="k">if</span> <span class="n">sandbox_dir</span> <span class="k">else</span> <span class="n">settings</span><span class="o">.</span><span class="n">DEFAULT_SANDBOX_DIR</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">supervisors</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># machine -&gt; supervisor contact/other info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wait_register</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ready_register</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_kill_and_launch</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__cfg_morph</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_exp_extension</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sv_processes</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># machine -&gt; Process objects)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unsupervised_peers</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">subprocess_mgr</span> <span class="o">=</span> <span class="n">SubprocessMonitor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">launch_file</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">]:</span>  <span class="c1"># command line arg</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_experiment_without_config</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_experiment_config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">launch_file</span><span class="p">,</span> <span class="n">overwrites</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;initialised config&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_changed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">status_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">details</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;status changed!!!&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">status_name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mx_addr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mx_pass</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="OBCIExperiment.net_init"><a class="viewcode-back" href="../../../../apidoc/obci.control.launcher.html#obci.control.launcher.obci_experiment.OBCIExperiment.net_init">[docs]</a>    <span class="k">def</span> <span class="nf">net_init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source_sub_socket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">SUB</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source_sub_socket</span><span class="o">.</span><span class="n">setsockopt_string</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">SUBSCRIBE</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_pub_addresses</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">addr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_pub_addresses</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">source_sub_socket</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_all_sockets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_sub_socket</span><span class="p">)</span>

        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">supervisors_rep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">supervisors_rep_addrs</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_socket</span><span class="p">(</span>
            <span class="p">[],</span>
            <span class="n">zmq</span><span class="o">.</span><span class="n">REP</span><span class="p">)</span>
        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">supervisors_sub</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">supervisors_sub_addrs</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">SUB</span><span class="p">),</span> <span class="p">[])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_all_sockets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">supervisors_sub</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_all_sockets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">supervisors_rep</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">OBCIExperiment</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">net_init</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rep_addresses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ip_based_addr</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">choose_addr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rep_addresses</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pub_addresses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ip_based_addr</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">choose_addr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pub_addresses</span><span class="p">)))</span>

        <span class="n">tcp_port</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_tcp_proxy_thr</span><span class="p">,</span> <span class="n">tcp_port</span> <span class="o">=</span> <span class="n">twisted_tcp_handling</span><span class="o">.</span><span class="n">run_twisted_server</span><span class="p">(</span>
            <span class="p">(</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="n">tcp_port</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rep_addresses</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tcp_addresses</span> <span class="o">=</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_ip</span><span class="p">,</span> <span class="n">tcp_port</span><span class="p">),</span>
                              <span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">(),</span> <span class="n">tcp_port</span><span class="p">)]</span></div>

    <span class="k">def</span> <span class="nf">_ip_based_addr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other_addr</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;tcp://&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_ip</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">port</span><span class="p">(</span><span class="n">other_addr</span><span class="p">))</span>

<div class="viewcode-block" id="OBCIExperiment.params_for_registration"><a class="viewcode-back" href="../../../../apidoc/obci.control.launcher.html#obci.control.launcher.obci_experiment.OBCIExperiment.params_for_registration">[docs]</a>    <span class="k">def</span> <span class="nf">params_for_registration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">pid</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">(),</span> <span class="n">origin_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">origin_machine</span><span class="p">,</span>
                    <span class="n">status_name</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">launch_file_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">launch_file</span><span class="p">,</span>
                    <span class="n">tcp_addrs</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tcp_addresses</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span></div>

    <span class="k">def</span> <span class="nf">_handle_registration_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nearby_machines</span><span class="o">.</span><span class="n">mass_update</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>

<div class="viewcode-block" id="OBCIExperiment.custom_sockets"><a class="viewcode-back" href="../../../../apidoc/obci.control.launcher.html#obci.control.launcher.obci_experiment.OBCIExperiment.custom_sockets">[docs]</a>    <span class="k">def</span> <span class="nf">custom_sockets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">source_sub_socket</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">supervisors_sub</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">supervisors_rep</span><span class="p">]</span></div>

<div class="viewcode-block" id="OBCIExperiment.args_for_process_sv"><a class="viewcode-back" href="../../../../apidoc/obci.control.launcher.html#obci.control.launcher.obci_experiment.OBCIExperiment.args_for_process_sv">[docs]</a>    <span class="k">def</span> <span class="nf">args_for_process_sv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">machine</span><span class="p">,</span> <span class="n">local</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;--sv-addresses&#39;</span><span class="p">]</span>
        <span class="n">local</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nearby_machines</span><span class="o">.</span><span class="n">is_this_machine</span><span class="p">(</span><span class="n">machine</span><span class="p">)</span>

        <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ip_based_addr</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">choose_addr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">supervisors_rep_addrs</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">local</span><span class="p">:</span>
            <span class="n">port</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">port</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
            <span class="n">a</span> <span class="o">=</span> <span class="s1">&#39;tcp://&#39;</span> <span class="o">+</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>
        <span class="c1"># sv_rep_ = net.choose_not_local(self.supervisors_rep_addrs)</span>
        <span class="c1"># if not sv_rep_ or local:</span>
        <span class="c1">#     sv_rep_ = net.choose_local(self.supervisors_rep_addrs)</span>

        <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>  <span class="c1"># addr_to_pass) # += sv_rep_[:1]</span>
        <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;--sv-pub-addresses&#39;</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ip_based_addr</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">choose_addr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pub_addresses</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">local</span><span class="p">:</span>
            <span class="n">port</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">port</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
            <span class="n">a</span> <span class="o">=</span> <span class="s1">&#39;tcp://&#39;</span> <span class="o">+</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>

        <span class="c1"># pub_addrs = net.choose_not_local(self.pub_addresses)</span>
        <span class="c1"># if not pub_addrs or local:</span>
        <span class="c1">#     pub_addrs = net.choose_local(self.pub_addresses, ip=True)</span>

        <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>  <span class="c1"># += pub_addrs[:1] #self.pub_addresses</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;obci_experiment&#39;</span> <span class="k">else</span>\
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">launch_file</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span>
            <span class="s1">&#39;--sandbox-dir&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sandbox_dir</span><span class="p">),</span>
            <span class="s1">&#39;--name&#39;</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span>
            <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">uuid</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span>
            <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">machine</span><span class="p">,</span>
            <span class="s1">&#39;--experiment-uuid&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">uuid</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">args</span></div>

    <span class="k">def</span> <span class="nf">_start_obci_process_supervisor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">machine_addr</span><span class="p">):</span>
        <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args_for_process_sv</span><span class="p">(</span><span class="n">machine_addr</span><span class="p">)</span>
        <span class="n">proc_type</span> <span class="o">=</span> <span class="s1">&#39;obci_process_supervisor&#39;</span>

        <span class="k">if</span> <span class="n">machine_addr</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin_machine</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;obci_process_supervisor&#39;</span>
            <span class="n">sv_obj</span><span class="p">,</span> <span class="n">details</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subprocess_mgr</span><span class="o">.</span><span class="n">new_local_process</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span>
                                                                    <span class="n">proc_type</span><span class="o">=</span><span class="n">proc_type</span><span class="p">,</span>
                                                                    <span class="n">capture_io</span><span class="o">=</span><span class="n">NO_STDIO</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">srv_ip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nearby_machines</span><span class="o">.</span><span class="n">ip</span><span class="p">(</span><span class="n">hostname</span><span class="o">=</span><span class="n">machine_addr</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">det</span> <span class="o">=</span> <span class="s2">&quot;Machine &quot;</span> <span class="o">+</span> <span class="n">machine_addr</span> <span class="o">+</span> <span class="s2">&quot; not found, cannot launch remote process!&quot;</span> <span class="o">+</span>\
                    <span class="s2">&quot;Is obci_server running there? &quot;</span> <span class="o">+</span>\
                    <span class="s2">&quot;If yes, maybe you should wait for a few seconds and retry.&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="n">det</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">det</span>

            <span class="n">conn_addr</span> <span class="o">=</span> <span class="s1">&#39;tcp://&#39;</span> <span class="o">+</span> <span class="n">srv_ip</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="n">net</span><span class="o">.</span><span class="n">server_rep_port</span><span class="p">()</span>
            <span class="n">sv_obj</span><span class="p">,</span> <span class="n">details</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subprocess_mgr</span><span class="o">.</span><span class="n">new_remote_process</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                                     <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span> <span class="n">proc_type</span><span class="o">=</span><span class="n">proc_type</span><span class="p">,</span>
                                                                     <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">machine_ip</span><span class="o">=</span><span class="n">machine_addr</span><span class="p">,</span>
                                                                     <span class="n">conn_addr</span><span class="o">=</span><span class="n">conn_addr</span><span class="p">,</span> <span class="n">capture_io</span><span class="o">=</span><span class="n">NO_STDIO</span>
                                                                     <span class="p">)</span>
        <span class="k">if</span> <span class="n">sv_obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">details</span>

        <span class="n">timeout_handler</span> <span class="o">=</span> <span class="n">TimeoutDescription</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">REGISTER_TIMEOUT</span><span class="p">,</span>
                                             <span class="n">timeout_method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_handle_register_sv_timeout</span><span class="p">,</span>
                                             <span class="n">timeout_args</span><span class="o">=</span><span class="p">[</span><span class="n">sv_obj</span><span class="p">])</span>
        <span class="n">sv_obj</span><span class="o">.</span><span class="n">set_registration_timeout_handler</span><span class="p">(</span><span class="n">timeout_handler</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sv_processes</span><span class="p">[</span><span class="n">machine_addr</span><span class="p">]</span> <span class="o">=</span> <span class="n">sv_obj</span>
        <span class="k">return</span> <span class="n">sv_obj</span><span class="p">,</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_start_obci_process_supervisors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">peer_machines</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wait_register</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">peer_machines</span><span class="p">)</span>
        <span class="n">details</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">machine</span> <span class="ow">in</span> <span class="n">peer_machines</span><span class="p">:</span>
            <span class="n">result</span><span class="p">,</span> <span class="n">details</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start_obci_process_supervisor</span><span class="p">(</span><span class="n">machine</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">launcher_tools</span><span class="o">.</span><span class="n">FAILED_LAUNCH</span><span class="p">,</span> <span class="n">details</span><span class="p">)</span>
                <span class="n">details</span> <span class="o">=</span> <span class="s2">&quot;FAILED to start supervisor: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">details</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">details</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">status_changed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">status_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">details</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">details</span>

            <span class="n">k</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">machine_ip</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sv_processes</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
        <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">details</span>

    <span class="k">def</span> <span class="nf">_send_launch_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_start_experiment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        START EXPERIMENT!!!!</span>
<span class="sd">        ##################################################################</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span><span class="p">,</span> <span class="n">details</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start_obci_process_supervisors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="o">.</span><span class="n">peer_machines</span><span class="p">())</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
            <span class="n">send_msg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_publish_socket</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtool</span><span class="o">.</span><span class="n">fill_msg</span><span class="p">(</span><span class="s2">&quot;experiment_launch_error&quot;</span><span class="p">,</span>
                                                               <span class="n">sender</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="n">details</span><span class="p">,</span>
                                                               <span class="n">err_code</span><span class="o">=</span><span class="s1">&#39;supervisor_launch_error&#39;</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="n">details</span>

    <span class="k">def</span> <span class="nf">_initialize_experiment_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">launch_file</span><span class="p">,</span> <span class="n">overwrites</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">launcher_tools</span><span class="o">.</span><span class="n">ExperimentStatus</span><span class="p">()</span>

        <span class="n">exp_config</span> <span class="o">=</span> <span class="n">system_config</span><span class="o">.</span><span class="n">OBCIExperimentConfig</span><span class="p">(</span><span class="n">uuid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
        <span class="n">exp_config</span><span class="o">.</span><span class="n">origin_machine</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin_machine</span>
        <span class="n">exp_config</span><span class="o">.</span><span class="n">launch_file_path</span> <span class="o">=</span> <span class="n">launch_file</span>

        <span class="n">result</span><span class="p">,</span> <span class="n">details</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_experiment_config</span><span class="p">(</span><span class="n">exp_config</span><span class="p">,</span> <span class="n">launch_file</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">overwrites</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="p">[</span><span class="n">ovr</span><span class="p">,</span> <span class="n">other</span><span class="p">]</span> <span class="ow">in</span> <span class="n">overwrites</span><span class="p">:</span>
                    <span class="n">exp_config</span><span class="o">.</span><span class="n">update_peer_config</span><span class="p">(</span><span class="n">other</span><span class="p">[</span><span class="s1">&#39;peer_id&#39;</span><span class="p">],</span> <span class="n">ovr</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">other</span><span class="p">[</span><span class="s1">&#39;config_file&#39;</span><span class="p">]:</span>
                        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">other</span><span class="p">[</span><span class="s1">&#39;config_file&#39;</span><span class="p">]:</span>
                            <span class="n">exp_config</span><span class="o">.</span><span class="n">file_update_peer_config</span><span class="p">(</span><span class="n">other</span><span class="p">[</span><span class="s1">&#39;peer_id&#39;</span><span class="p">],</span> <span class="n">f</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">details</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="n">exp_config</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
        <span class="n">status</span><span class="o">.</span><span class="n">details</span> <span class="o">=</span> <span class="n">details</span>
        <span class="c1"># status_changed(status.status_name, status.details)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">launch_file</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;No launch file&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;- - - - - - - NEW LAUNCH FILE INVALID!!!  - - - - - - - &quot;</span>
                              <span class="s2">&quot;status: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">status</span><span class="o">.</span><span class="n">as_dict</span><span class="p">())</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">details</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">exp_config</span><span class="p">,</span> <span class="n">status</span>

    <span class="k">def</span> <span class="nf">_initialize_experiment_without_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">launcher_tools</span><span class="o">.</span><span class="n">ExperimentStatus</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">launcher_tools</span><span class="o">.</span><span class="n">NOT_READY</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="s2">&quot;No launch_file&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span> <span class="o">=</span> <span class="n">system_config</span><span class="o">.</span><span class="n">OBCIExperimentConfig</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="o">.</span><span class="n">origin_machine</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin_machine</span>

<div class="viewcode-block" id="OBCIExperiment.make_experiment_config"><a class="viewcode-back" href="../../../../apidoc/obci.control.launcher.html#obci.control.launcher.obci_experiment.OBCIExperiment.make_experiment_config">[docs]</a>    <span class="k">def</span> <span class="nf">make_experiment_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp_config</span><span class="p">,</span> <span class="n">launch_file</span><span class="p">,</span> <span class="n">status</span><span class="p">):</span>
        <span class="n">launch_parser</span> <span class="o">=</span> <span class="n">launch_file_parser</span><span class="o">.</span><span class="n">LaunchFileParser</span><span class="p">(</span>
            <span class="n">launcher_tools</span><span class="o">.</span><span class="n">obci_root</span><span class="p">(),</span> <span class="n">settings</span><span class="o">.</span><span class="n">DEFAULT_SCENARIO_DIR</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">launch_file</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Empty scenario.&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">launcher_tools</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="n">launch_file</span><span class="p">))</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;launch file opened &quot;</span> <span class="o">+</span> <span class="n">launch_file</span><span class="p">)</span>
                <span class="n">launch_parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">exp_config</span><span class="p">,</span> <span class="n">apply_globals</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Launch file invalid.....&quot;</span> <span class="o">+</span> <span class="n">launch_file</span><span class="p">)</span>
            <span class="n">status</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">launcher_tools</span><span class="o">.</span><span class="n">NOT_READY</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="c1"># print self.exp_config</span>
        <span class="n">rd</span><span class="p">,</span> <span class="n">details</span> <span class="o">=</span> <span class="n">exp_config</span><span class="o">.</span><span class="n">config_ready</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">rd</span><span class="p">:</span>
            <span class="n">status</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">launcher_tools</span><span class="o">.</span><span class="n">READY_TO_LAUNCH</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">status</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">launcher_tools</span><span class="o">.</span><span class="n">NOT_READY</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="n">details</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="OBCIExperiment.status_changed"><a class="viewcode-back" href="../../../../apidoc/obci.control.launcher.html#obci.control.launcher.obci_experiment.OBCIExperiment.status_changed">[docs]</a>    <span class="k">def</span> <span class="nf">status_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status_name</span><span class="p">,</span> <span class="n">details</span><span class="p">,</span> <span class="n">peers</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># TODO use PUB/SUB pattern</span>
        <span class="n">send_msg</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">source_req_socket</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mtool</span><span class="o">.</span><span class="n">fill_msg</span><span class="p">(</span>
                <span class="s1">&#39;experiment_status_change&#39;</span><span class="p">,</span>
                <span class="n">status_name</span><span class="o">=</span><span class="n">status_name</span><span class="p">,</span>
                <span class="n">details</span><span class="o">=</span><span class="n">details</span><span class="p">,</span>
                <span class="n">uuid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                <span class="n">peers</span><span class="o">=</span><span class="n">peers</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">poller</span><span class="o">.</span><span class="n">poll_recv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_req_socket</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">8000</span><span class="p">)</span></div>

<div class="viewcode-block" id="OBCIExperiment.peer_type"><a class="viewcode-back" href="../../../../apidoc/obci.control.launcher.html#obci.control.launcher.obci_experiment.OBCIExperiment.peer_type">[docs]</a>    <span class="k">def</span> <span class="nf">peer_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;obci_experiment&#39;</span></div>

    <span class="nd">@msg_handlers</span><span class="o">.</span><span class="n">handler</span><span class="p">(</span><span class="s1">&#39;register_peer&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="OBCIExperiment.handle_register_peer"><a class="viewcode-back" href="../../../../apidoc/obci.control.launcher.html#obci.control.launcher.obci_experiment.OBCIExperiment.handle_register_peer">[docs]</a>    <span class="k">def</span> <span class="nf">handle_register_peer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">sock</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Experiment&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">message</span><span class="o">.</span><span class="n">peer_type</span> <span class="o">==</span> <span class="s2">&quot;obci_process_supervisor&quot;</span><span class="p">:</span>

            <span class="n">machine</span><span class="p">,</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">other_params</span><span class="p">[</span><span class="s1">&#39;machine&#39;</span><span class="p">],</span> <span class="n">message</span><span class="o">.</span><span class="n">other_params</span><span class="p">[</span><span class="s1">&#39;pid&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">message</span><span class="o">.</span><span class="n">other_params</span><span class="p">[</span><span class="s1">&#39;mx_data&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mx_addr</span><span class="p">:</span>
                <span class="c1"># right now we support only one mx per obci instance</span>
                <span class="n">ip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nearby_machines</span><span class="o">.</span><span class="n">ip</span><span class="p">(</span><span class="n">machine</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nearby_machines</span><span class="o">.</span><span class="n">dict_snapshot</span><span class="p">()</span> <span class="k">else</span>\
                    <span class="n">machine</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">mx_addr</span> <span class="o">=</span> <span class="n">ip</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="n">message</span><span class="o">.</span><span class="n">other_params</span><span class="p">[</span><span class="s1">&#39;mx_data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mx_pass</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">other_params</span><span class="p">[</span><span class="s1">&#39;mx_data&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

            <span class="n">proc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subprocess_mgr</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">machine</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">proc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">send_msg</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtool</span><span class="o">.</span><span class="n">fill_msg</span><span class="p">(</span><span class="s2">&quot;rq_error&quot;</span><span class="p">,</span>
                                                   <span class="n">err_code</span><span class="o">=</span><span class="s1">&#39;process_not_found&#39;</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">dict</span><span class="p">()))</span>
                <span class="k">return</span>

            <span class="n">status</span><span class="p">,</span> <span class="n">details</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">status</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">status</span> <span class="o">!=</span> <span class="n">subprocess_monitor</span><span class="o">.</span><span class="n">UNKNOWN</span><span class="p">:</span>
                <span class="n">send_msg</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtool</span><span class="o">.</span><span class="n">fill_msg</span><span class="p">(</span><span class="s2">&quot;rq_error&quot;</span><span class="p">,</span>
                                                   <span class="n">err_code</span><span class="o">=</span><span class="s1">&#39;process_status_invalid&#39;</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">dict</span><span class="p">(),</span>
                                                   <span class="n">details</span><span class="o">=</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">details</span><span class="p">)))</span>
                <span class="n">send_msg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_publish_socket</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtool</span><span class="o">.</span><span class="n">fill_msg</span><span class="p">(</span><span class="s2">&quot;experiment_launch_error&quot;</span><span class="p">,</span>
                                                                   <span class="n">sender</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">details</span><span class="p">),</span>
                                                                   <span class="n">err_code</span><span class="o">=</span><span class="s1">&#39;registration_error&#39;</span><span class="p">))</span>
                <span class="k">return</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;exp registration message  &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">vars</span><span class="p">(</span><span class="n">message</span><span class="p">)))</span>
            <span class="n">adr_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">message</span><span class="o">.</span><span class="n">rep_addrs</span><span class="p">,</span> <span class="n">message</span><span class="o">.</span><span class="n">pub_addrs</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">machine</span> <span class="o">!=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">():</span>
                <span class="n">ip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nearby_machines</span><span class="o">.</span><span class="n">ip</span><span class="p">(</span><span class="n">machine</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">addrs</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="n">message</span><span class="o">.</span><span class="n">rep_addrs</span><span class="p">,</span> <span class="n">message</span><span class="o">.</span><span class="n">pub_addrs</span><span class="p">]):</span>
                    <span class="n">first</span> <span class="o">=</span> <span class="n">addrs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">port</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">port</span><span class="p">(</span><span class="n">first</span><span class="p">)</span>
                    <span class="n">adr_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;tcp://&#39;</span> <span class="o">+</span> <span class="n">ip</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">port</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;addresses after filtering: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">adr_list</span><span class="p">))</span>
            <span class="n">desc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">supervisors</span><span class="p">[</span><span class="n">machine</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">RegistrationDescription</span><span class="p">(</span>
                <span class="n">message</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                <span class="n">message</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">adr_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">adr_list</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">message</span><span class="o">.</span><span class="n">other_params</span><span class="p">[</span><span class="s1">&#39;machine&#39;</span><span class="p">],</span>
                <span class="n">message</span><span class="o">.</span><span class="n">other_params</span><span class="p">[</span><span class="s1">&#39;pid&#39;</span><span class="p">])</span>
            <span class="n">proc</span><span class="o">.</span><span class="n">registered</span><span class="p">(</span><span class="n">desc</span><span class="p">)</span>
            <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_choose_process_address</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="n">desc</span><span class="o">.</span><span class="n">pub_addrs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">supervisors_sub_addrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">supervisors_sub</span><span class="o">.</span><span class="n">setsockopt_string</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">SUBSCRIBE</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">supervisors_sub</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Connecting to supervisor pub address </span><span class="si">{0}</span><span class="s2"> (</span><span class="si">{1}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">machine</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Could not find suitable PUB address to connect. (supervisor on &quot;</span> <span class="o">+</span> <span class="n">machine</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>

            <span class="n">launch_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="o">.</span><span class="n">launch_data</span><span class="p">(</span><span class="n">machine</span><span class="p">)</span>
            <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="o">.</span><span class="n">peer_order</span><span class="p">()</span>

            <span class="n">send_msg</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtool</span><span class="o">.</span><span class="n">fill_msg</span><span class="p">(</span><span class="s2">&quot;rq_ok&quot;</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">launch_data</span><span class="o">=</span><span class="n">launch_data</span><span class="p">,</span>
                                                                    <span class="n">peer_order</span><span class="o">=</span><span class="n">order</span><span class="p">)))</span>

            <span class="c1"># inform observers</span>
            <span class="n">send_msg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_publish_socket</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtool</span><span class="o">.</span><span class="n">fill_msg</span><span class="p">(</span><span class="s2">&quot;process_supervisor_registered&quot;</span><span class="p">,</span>
                                                               <span class="n">sender</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                                               <span class="n">machine_ip</span><span class="o">=</span><span class="n">desc</span><span class="o">.</span><span class="n">machine_ip</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_wait_register</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wait_register</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kill_and_launch</span><span class="p">:</span>
                    <span class="n">kill</span><span class="p">,</span> <span class="n">launch</span><span class="p">,</span> <span class="n">new_supervisors</span><span class="p">,</span> <span class="n">keep_configs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kill_and_launch</span>
                    <span class="n">to_launch</span> <span class="o">=</span> <span class="n">launch</span><span class="p">[</span><span class="n">machine</span><span class="p">]</span>
                    <span class="n">to_kill</span> <span class="o">=</span> <span class="n">kill</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">machine</span><span class="p">,</span> <span class="p">[])</span>
                    <span class="n">send_msg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_publish_socket</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtool</span><span class="o">.</span><span class="n">fill_msg</span><span class="p">(</span><span class="s2">&quot;manage_peers&quot;</span><span class="p">,</span>
                                                                       <span class="n">kill_peers</span><span class="o">=</span><span class="n">to_kill</span><span class="p">,</span> <span class="n">start_peers_data</span><span class="o">=</span><span class="n">to_launch</span><span class="p">,</span>
                                                                       <span class="n">receiver</span><span class="o">=</span><span class="n">desc</span><span class="o">.</span><span class="n">uuid</span><span class="p">))</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exp_extension</span><span class="p">:</span>
                    <span class="n">ldata</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">peer_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exp_extension</span><span class="p">[</span><span class="n">machine</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">ldata</span><span class="p">[</span><span class="n">peer_id</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="o">.</span><span class="n">launch_data</span><span class="p">(</span><span class="n">machine</span><span class="p">)[</span><span class="n">peer_id</span><span class="p">]</span>
                    <span class="n">send_msg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_publish_socket</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtool</span><span class="o">.</span><span class="n">fill_msg</span><span class="p">(</span><span class="s2">&quot;start_peers&quot;</span><span class="p">,</span> <span class="n">mx_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mx_args</span><span class="p">(),</span>
                                                                       <span class="n">add_launch_data</span><span class="o">=</span><span class="p">{</span><span class="n">machine</span><span class="p">:</span> <span class="n">ldata</span><span class="p">}))</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">send_msg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_publish_socket</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtool</span><span class="o">.</span><span class="n">fill_msg</span><span class="p">(</span><span class="s2">&quot;start_broker&quot;</span><span class="p">,</span>
                                                                       <span class="n">args</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mx_args</span><span class="p">()))</span></div>

<div class="viewcode-block" id="OBCIExperiment.mx_args"><a class="viewcode-back" href="../../../../apidoc/obci.control.launcher.html#obci.control.launcher.obci_experiment.OBCIExperiment.mx_args">[docs]</a>    <span class="k">def</span> <span class="nf">mx_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;run_multiplexer&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mx_addr</span><span class="p">]</span></div>
        <span class="c1"># &#39;--multiplexer-password&#39;, self.mx_pass</span>
        <span class="c1"># &#39;--rules&#39;, launcher_tools.mx_rules_path()]</span>

    <span class="nd">@msg_handlers</span><span class="o">.</span><span class="n">handler</span><span class="p">(</span><span class="s2">&quot;launched_process_info&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="OBCIExperiment.handle_launched_process_info"><a class="viewcode-back" href="../../../../apidoc/obci.control.launcher.html#obci.control.launcher.obci_experiment.OBCIExperiment.handle_launched_process_info">[docs]</a>    <span class="k">def</span> <span class="nf">handle_launched_process_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">sock</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">message</span><span class="o">.</span><span class="n">proc_type</span> <span class="o">==</span> <span class="s1">&#39;multiplexer&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_wait_register</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="o">.</span><span class="n">peer_machines</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">peer_status</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span>
                <span class="n">launcher_tools</span><span class="o">.</span><span class="n">RUNNING</span><span class="p">)</span>
            <span class="c1"># tmp.synchro workaround: give MX some time to initialize</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)</span>
            <span class="n">send_msg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_publish_socket</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtool</span><span class="o">.</span><span class="n">fill_msg</span><span class="p">(</span><span class="s1">&#39;start_config_server&#39;</span><span class="p">,</span> <span class="n">mx_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mx_args</span><span class="p">()))</span>
        <span class="k">elif</span> <span class="n">message</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;config_server&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">peer_status</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span>
                <span class="n">launcher_tools</span><span class="o">.</span><span class="n">RUNNING</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kill_and_launch</span><span class="p">:</span>
                <span class="n">kill_data</span><span class="p">,</span> <span class="n">launch_data</span><span class="p">,</span> <span class="n">new_supervisors</span><span class="p">,</span> <span class="n">keep_configs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kill_and_launch</span>
                <span class="k">for</span> <span class="n">machine</span> <span class="ow">in</span> <span class="n">kill_data</span><span class="p">:</span>
                    <span class="n">to_kill</span> <span class="o">=</span> <span class="n">kill_data</span><span class="p">[</span><span class="n">machine</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">machine</span> <span class="ow">in</span> <span class="n">launch_data</span><span class="p">:</span>
                        <span class="n">to_launch</span> <span class="o">=</span> <span class="n">launch_data</span><span class="p">[</span><span class="n">machine</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">to_launch</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">send_msg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_publish_socket</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtool</span><span class="o">.</span><span class="n">fill_msg</span><span class="p">(</span><span class="s2">&quot;manage_peers&quot;</span><span class="p">,</span>
                                                                       <span class="n">kill_peers</span><span class="o">=</span><span class="n">to_kill</span><span class="p">,</span> <span class="n">start_peers_data</span><span class="o">=</span><span class="n">to_launch</span><span class="p">,</span>
                                                                       <span class="n">receiver</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">supervisors</span><span class="p">[</span><span class="n">machine</span><span class="p">]</span><span class="o">.</span><span class="n">uuid</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">machine</span> <span class="ow">in</span> <span class="n">launch_data</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">machine</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">new_supervisors</span> <span class="ow">and</span> <span class="n">machine</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kill_data</span><span class="p">:</span>
                        <span class="n">to_kill</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">to_launch</span> <span class="o">=</span> <span class="n">launch_data</span><span class="p">[</span><span class="n">machine</span><span class="p">]</span>
                        <span class="n">send_msg</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_publish_socket</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">mtool</span><span class="o">.</span><span class="n">fill_msg</span><span class="p">(</span>
                                <span class="s2">&quot;manage_peers&quot;</span><span class="p">,</span>
                                <span class="n">kill_peers</span><span class="o">=</span><span class="n">to_kill</span><span class="p">,</span>
                                <span class="n">start_peers_data</span><span class="o">=</span><span class="n">to_launch</span><span class="p">,</span>
                                <span class="n">receiver</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">supervisors</span><span class="p">[</span><span class="n">machine</span><span class="p">]</span><span class="o">.</span><span class="n">uuid</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">send_msg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_publish_socket</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtool</span><span class="o">.</span><span class="n">fill_msg</span><span class="p">(</span><span class="s1">&#39;start_peers&#39;</span><span class="p">,</span>
                                                                   <span class="n">mx_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mx_args</span><span class="p">()))</span>
        <span class="k">elif</span> <span class="n">message</span><span class="o">.</span><span class="n">proc_type</span> <span class="o">==</span> <span class="s1">&#39;obci_peer&#39;</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">peer_status</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span>
                <span class="n">launcher_tools</span><span class="o">.</span><span class="n">LAUNCHING</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_changed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">status_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">details</span><span class="p">,</span>
                            <span class="n">peers</span><span class="o">=</span><span class="p">{</span><span class="n">message</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">peer_status</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">status_name</span><span class="p">})</span></div>

    <span class="nd">@msg_handlers</span><span class="o">.</span><span class="n">handler</span><span class="p">(</span><span class="s2">&quot;all_peers_launched&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="OBCIExperiment.handle_all_peers_launched"><a class="viewcode-back" href="../../../../apidoc/obci.control.launcher.html#obci.control.launcher.obci_experiment.OBCIExperiment.handle_all_peers_launched">[docs]</a>    <span class="k">def</span> <span class="nf">handle_all_peers_launched</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">sock</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exp_extension</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_exp_extension</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;all additional peers launched.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_wait_register</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_wait_register</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wait_register</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">launcher_tools</span><span class="o">.</span><span class="n">LAUNCHING</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status_changed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">status_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">details</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kill_and_launch</span><span class="p">:</span>  <span class="c1"># if kill/launch, this variable was set in _kill_and_launch_peers()</span>
            <span class="c1"># without mx and config_server, for now default is 1 mx</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ready_register</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="o">.</span><span class="n">peers</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span></div>

    <span class="k">def</span> <span class="nf">_choose_process_address</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proc</span><span class="p">,</span> <span class="n">addresses</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;(exp) choosing sv address:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">addresses</span><span class="p">))</span>
        <span class="n">addrs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">chosen</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">proc</span><span class="o">.</span><span class="n">is_local</span><span class="p">():</span>
            <span class="n">addrs</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">choose_local</span><span class="p">(</span><span class="n">addresses</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">addrs</span><span class="p">:</span>
            <span class="n">addrs</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">choose_not_local</span><span class="p">(</span><span class="n">addresses</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">addrs</span><span class="p">:</span>
            <span class="n">chosen</span> <span class="o">=</span> <span class="n">addrs</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">chosen</span>

    <span class="nd">@msg_handlers</span><span class="o">.</span><span class="n">handler</span><span class="p">(</span><span class="s1">&#39;get_experiment_info&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="OBCIExperiment.handle_get_experiment_info"><a class="viewcode-back" href="../../../../apidoc/obci.control.launcher.html#obci.control.launcher.obci_experiment.OBCIExperiment.handle_get_experiment_info">[docs]</a>    <span class="k">def</span> <span class="nf">handle_get_experiment_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">sock</span><span class="p">):</span>
        <span class="n">send_msg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_publish_socket</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtool</span><span class="o">.</span><span class="n">fill_msg</span><span class="p">(</span><span class="s1">&#39;rq_ok&#39;</span><span class="p">))</span>
        <span class="n">send_msg</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtool</span><span class="o">.</span><span class="n">fill_msg</span><span class="p">(</span><span class="s1">&#39;experiment_info&#39;</span><span class="p">,</span>
                                           <span class="n">experiment_status</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">as_dict</span><span class="p">(),</span>
                                           <span class="n">unsupervised_peers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unsupervised_peers</span><span class="p">,</span>
                                           <span class="n">origin_machine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="o">.</span><span class="n">origin_machine</span><span class="p">,</span>
                                           <span class="n">uuid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                           <span class="n">scenario_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="o">.</span><span class="n">scenario_dir</span><span class="p">,</span>
                                           <span class="n">peers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="o">.</span><span class="n">peers_info</span><span class="p">(),</span>
                                           <span class="n">launch_file_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="o">.</span><span class="n">launch_file_path</span><span class="p">,</span>
                                           <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span></div>

    <span class="nd">@msg_handlers</span><span class="o">.</span><span class="n">handler</span><span class="p">(</span><span class="s1">&#39;get_peer_info&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="OBCIExperiment.handle_get_peer_info"><a class="viewcode-back" href="../../../../apidoc/obci.control.launcher.html#obci.control.launcher.obci_experiment.OBCIExperiment.handle_get_peer_info">[docs]</a>    <span class="k">def</span> <span class="nf">handle_get_peer_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">sock</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">message</span><span class="o">.</span><span class="n">peer_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="o">.</span><span class="n">peers</span><span class="p">:</span>
            <span class="n">send_msg</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtool</span><span class="o">.</span><span class="n">fill_msg</span><span class="p">(</span><span class="s1">&#39;rq_error&#39;</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">dict</span><span class="p">(),</span>
                                               <span class="n">err_code</span><span class="o">=</span><span class="s1">&#39;peer_id_not_found&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">peer_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="o">.</span><span class="n">peers</span><span class="p">[</span><span class="n">message</span><span class="o">.</span><span class="n">peer_id</span><span class="p">]</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">detailed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">send_msg</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtool</span><span class="o">.</span><span class="n">fill_msg</span><span class="p">(</span><span class="s1">&#39;peer_info&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">peer_info</span><span class="p">))</span></div>

    <span class="nd">@msg_handlers</span><span class="o">.</span><span class="n">handler</span><span class="p">(</span><span class="s1">&#39;get_peer_param_values&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="OBCIExperiment.handle_get_peer_param_values"><a class="viewcode-back" href="../../../../apidoc/obci.control.launcher.html#obci.control.launcher.obci_experiment.OBCIExperiment.handle_get_peer_param_values">[docs]</a>    <span class="k">def</span> <span class="nf">handle_get_peer_param_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">sock</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">message</span><span class="o">.</span><span class="n">peer_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="o">.</span><span class="n">peers</span><span class="p">:</span>
            <span class="n">send_msg</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtool</span><span class="o">.</span><span class="n">fill_msg</span><span class="p">(</span><span class="s1">&#39;rq_error&#39;</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">dict</span><span class="p">(),</span>
                                               <span class="n">err_code</span><span class="o">=</span><span class="s1">&#39;peer_id_not_found&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">peer_id</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">peer_id</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="o">.</span><span class="n">all_param_values</span><span class="p">(</span><span class="n">peer_id</span><span class="p">)</span>
            <span class="n">send_msg</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtool</span><span class="o">.</span><span class="n">fill_msg</span><span class="p">(</span><span class="s1">&#39;peer_param_values&#39;</span><span class="p">,</span>
                                               <span class="n">peer_id</span><span class="o">=</span><span class="n">peer_id</span><span class="p">,</span> <span class="n">param_values</span><span class="o">=</span><span class="n">vals</span><span class="p">,</span>
                                               <span class="n">sender</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uuid</span><span class="p">))</span></div>

    <span class="nd">@msg_handlers</span><span class="o">.</span><span class="n">handler</span><span class="p">(</span><span class="s1">&#39;get_peer_config&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="OBCIExperiment.handle_get_peer_config"><a class="viewcode-back" href="../../../../apidoc/obci.control.launcher.html#obci.control.launcher.obci_experiment.OBCIExperiment.handle_get_peer_config">[docs]</a>    <span class="k">def</span> <span class="nf">handle_get_peer_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">sock</span><span class="p">):</span>
        <span class="n">send_msg</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtool</span><span class="o">.</span><span class="n">fill_msg</span><span class="p">(</span><span class="s1">&#39;ping&#39;</span><span class="p">,</span> <span class="n">sender</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uuid</span><span class="p">))</span></div>

    <span class="nd">@msg_handlers</span><span class="o">.</span><span class="n">handler</span><span class="p">(</span><span class="s1">&#39;get_experiment_scenario&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="OBCIExperiment.handle_get_experiment_scenario"><a class="viewcode-back" href="../../../../apidoc/obci.control.launcher.html#obci.control.launcher.obci_experiment.OBCIExperiment.handle_get_experiment_scenario">[docs]</a>    <span class="k">def</span> <span class="nf">handle_get_experiment_scenario</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">sock</span><span class="p">):</span>
        <span class="n">jsoned</span> <span class="o">=</span> <span class="n">serialize_scenario_json</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="p">)</span>
        <span class="n">send_msg</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtool</span><span class="o">.</span><span class="n">fill_msg</span><span class="p">(</span><span class="s1">&#39;experiment_scenario&#39;</span><span class="p">,</span> <span class="n">scenario</span><span class="o">=</span><span class="n">jsoned</span><span class="p">))</span></div>

    <span class="nd">@msg_handlers</span><span class="o">.</span><span class="n">handler</span><span class="p">(</span><span class="s1">&#39;set_experiment_scenario&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="OBCIExperiment.handle_set_experiment_scenario"><a class="viewcode-back" href="../../../../apidoc/obci.control.launcher.html#obci.control.launcher.obci_experiment.OBCIExperiment.handle_set_experiment_scenario">[docs]</a>    <span class="k">def</span> <span class="nf">handle_set_experiment_scenario</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">sock</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="o">.</span><span class="n">peers</span><span class="p">:</span>
            <span class="n">send_msg</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtool</span><span class="o">.</span><span class="n">fill_msg</span><span class="p">(</span><span class="s1">&#39;rq_error&#39;</span><span class="p">,</span> <span class="n">err_code</span><span class="o">=</span><span class="s1">&#39;scenario_already_set&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">jsonpar</span> <span class="o">=</span> <span class="n">launch_file_parser</span><span class="o">.</span><span class="n">LaunchJSONParser</span><span class="p">(</span>
                <span class="n">launcher_tools</span><span class="o">.</span><span class="n">obci_root</span><span class="p">(),</span> <span class="n">settings</span><span class="o">.</span><span class="n">DEFAULT_SCENARIO_DIR</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="o">.</span><span class="n">launch_file_path</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">inbuf</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">scenario</span><span class="p">)</span>
            <span class="n">jsonpar</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">inbuf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;set experiment scenario............... </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">message</span><span class="o">.</span><span class="n">scenario</span><span class="p">)</span>

            <span class="n">rd</span><span class="p">,</span> <span class="n">details</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="o">.</span><span class="n">config_ready</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">rd</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">launcher_tools</span><span class="o">.</span><span class="n">READY_TO_LAUNCH</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">launcher_tools</span><span class="o">.</span><span class="n">NOT_READY</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="n">details</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;scenario not ready </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">rd</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">details</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">launch_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="o">.</span><span class="n">launch_file_path</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">launch_file_path</span>
            <span class="n">send_msg</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtool</span><span class="o">.</span><span class="n">fill_msg</span><span class="p">(</span><span class="s1">&#39;rq_ok&#39;</span><span class="p">))</span>
            <span class="n">send_msg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_publish_socket</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtool</span><span class="o">.</span><span class="n">fill_msg</span><span class="p">(</span><span class="s1">&#39;experiment_scenario&#39;</span><span class="p">,</span>
                                                               <span class="n">scenario</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">scenario</span><span class="p">,</span>
                                                               <span class="n">launch_file_path</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">launch_file_path</span><span class="p">,</span>
                                                               <span class="n">uuid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uuid</span><span class="p">))</span>
            <span class="n">send_msg</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">source_req_socket</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mtool</span><span class="o">.</span><span class="n">fill_msg</span><span class="p">(</span>
                    <span class="s1">&#39;experiment_info_change&#39;</span><span class="p">,</span>
                    <span class="n">uuid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">launch_file_path</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">launch_file_path</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">poller</span><span class="o">.</span><span class="n">poll_recv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_req_socket</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">8000</span><span class="p">)</span></div>

    <span class="nd">@msg_handlers</span><span class="o">.</span><span class="n">handler</span><span class="p">(</span><span class="s1">&#39;start_experiment&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="OBCIExperiment.handle_start_experiment"><a class="viewcode-back" href="../../../../apidoc/obci.control.launcher.html#obci.control.launcher.obci_experiment.OBCIExperiment.handle_start_experiment">[docs]</a>    <span class="k">def</span> <span class="nf">handle_start_experiment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">sock</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">status_name</span> <span class="o">==</span> <span class="n">launcher_tools</span><span class="o">.</span><span class="n">READY_TO_LAUNCH</span><span class="p">:</span>
            <span class="n">send_msg</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtool</span><span class="o">.</span><span class="n">fill_msg</span><span class="p">(</span><span class="s1">&#39;rq_error&#39;</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">dict</span><span class="p">(),</span>
                                               <span class="n">err_code</span><span class="o">=</span><span class="s1">&#39;exp_status_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">status_name</span><span class="p">,</span>
                                               <span class="n">details</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">details</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">launcher_tools</span><span class="o">.</span><span class="n">LAUNCHING</span><span class="p">)</span>
            <span class="n">send_msg</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtool</span><span class="o">.</span><span class="n">fill_msg</span><span class="p">(</span><span class="s1">&#39;starting_experiment&#39;</span><span class="p">,</span>
                                               <span class="n">sender</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uuid</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status_changed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">status_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">details</span><span class="p">)</span>
            <span class="n">result</span><span class="p">,</span> <span class="n">details</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start_experiment</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
                <span class="n">send_msg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_publish_socket</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtool</span><span class="o">.</span><span class="n">fill_msg</span><span class="p">(</span><span class="s2">&quot;experiment_launch_error&quot;</span><span class="p">,</span>
                                                                   <span class="n">sender</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">err_code</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="n">details</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;EXPERIMENT LAUNCH ERROR!!!&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">launcher_tools</span><span class="o">.</span><span class="n">FAILED_LAUNCH</span><span class="p">,</span> <span class="n">details</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status_changed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">status_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">details</span><span class="p">)</span></div>

    <span class="nd">@msg_handlers</span><span class="o">.</span><span class="n">handler</span><span class="p">(</span><span class="s1">&#39;join_experiment&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="OBCIExperiment.handle_join_experiment"><a class="viewcode-back" href="../../../../apidoc/obci.control.launcher.html#obci.control.launcher.obci_experiment.OBCIExperiment.handle_join_experiment">[docs]</a>    <span class="k">def</span> <span class="nf">handle_join_experiment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">sock</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">message</span><span class="o">.</span><span class="n">peer_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="o">.</span><span class="n">peers</span> <span class="ow">or</span> \
                <span class="n">message</span><span class="o">.</span><span class="n">peer_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unsupervised_peers</span><span class="p">:</span>
            <span class="n">send_msg</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtool</span><span class="o">.</span><span class="n">fill_msg</span><span class="p">(</span><span class="s1">&#39;rq_error&#39;</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">dict</span><span class="p">(),</span>
                                               <span class="n">err_code</span><span class="o">=</span><span class="s1">&#39;peer_id_in_use&#39;</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mx_addr</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s1">&#39;mx&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="o">.</span><span class="n">peers</span><span class="p">:</span>
            <span class="n">send_msg</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtool</span><span class="o">.</span><span class="n">fill_msg</span><span class="p">(</span><span class="s1">&#39;rq_error&#39;</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">dict</span><span class="p">(),</span>
                                               <span class="n">err_code</span><span class="o">=</span><span class="s1">&#39;mx_not_running&#39;</span><span class="p">))</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">status_name</span> <span class="o">!=</span> <span class="n">launcher_tools</span><span class="o">.</span><span class="n">RUNNING</span> <span class="ow">and</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">status_name</span> <span class="o">!=</span> <span class="n">launcher_tools</span><span class="o">.</span><span class="n">LAUNCHING</span><span class="p">:</span>
            <span class="c1"># temporary status bug workaround.</span>
            <span class="n">send_msg</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtool</span><span class="o">.</span><span class="n">fill_msg</span><span class="p">(</span><span class="s1">&#39;rq_error&#39;</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">dict</span><span class="p">(),</span>
                                               <span class="n">err_code</span><span class="o">=</span><span class="s1">&#39;exp_status_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">status_name</span><span class="p">,</span>
                                               <span class="n">details</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unsupervised_peers</span><span class="p">[</span><span class="n">message</span><span class="o">.</span><span class="n">peer_id</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">peer_type</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">peer_type</span><span class="p">,</span>
                                                            <span class="n">path</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
            <span class="n">send_msg</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtool</span><span class="o">.</span><span class="n">fill_msg</span><span class="p">(</span><span class="s1">&#39;rq_ok&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">mx_addr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mx_addr</span><span class="p">)))</span></div>

    <span class="nd">@msg_handlers</span><span class="o">.</span><span class="n">handler</span><span class="p">(</span><span class="s1">&#39;leave_experiment&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="OBCIExperiment.handle_leave_experiment"><a class="viewcode-back" href="../../../../apidoc/obci.control.launcher.html#obci.control.launcher.obci_experiment.OBCIExperiment.handle_leave_experiment">[docs]</a>    <span class="k">def</span> <span class="nf">handle_leave_experiment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">sock</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">message</span><span class="o">.</span><span class="n">peer_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unsupervised_peers</span><span class="p">:</span>
            <span class="n">send_msg</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtool</span><span class="o">.</span><span class="n">fill_msg</span><span class="p">(</span><span class="s1">&#39;rq_error&#39;</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">dict</span><span class="p">(),</span>
                                               <span class="n">err_code</span><span class="o">=</span><span class="s1">&#39;peer_id_not_found&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">unsupervised_peers</span><span class="p">[</span><span class="n">message</span><span class="o">.</span><span class="n">peer_id</span><span class="p">]</span>
            <span class="n">send_msg</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtool</span><span class="o">.</span><span class="n">fill_msg</span><span class="p">(</span><span class="s1">&#39;rq_ok&#39;</span><span class="p">))</span></div>

    <span class="nd">@msg_handlers</span><span class="o">.</span><span class="n">handler</span><span class="p">(</span><span class="s1">&#39;add_peer&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="OBCIExperiment.handle_add_peer"><a class="viewcode-back" href="../../../../apidoc/obci.control.launcher.html#obci.control.launcher.obci_experiment.OBCIExperiment.handle_add_peer">[docs]</a>    <span class="k">def</span> <span class="nf">handle_add_peer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">sock</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add new peer to existing scenario. It may run on a different machine than</span>
<span class="sd">        already running peers. add_peer works at runtime and before runtime.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Handle add peer: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
        <span class="n">machine</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">machine</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin_machine</span>
        <span class="n">peer_id</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">peer_id</span>
        <span class="n">_launching</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># state of the (maybe ongoing) launching process</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">status_name</span> <span class="ow">in</span> <span class="n">launcher_tools</span><span class="o">.</span><span class="n">POST_RUN_STATUSES</span><span class="p">)</span> <span class="ow">or</span>\
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">status_name</span> <span class="o">==</span> <span class="n">launcher_tools</span><span class="o">.</span><span class="n">READY_TO_LAUNCH</span> <span class="ow">and</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">peer_status_exists</span><span class="p">(</span><span class="n">launcher_tools</span><span class="o">.</span><span class="n">LAUNCHING</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;add peer - experiment status incompatible!&quot;</span><span class="p">)</span>
            <span class="n">send_msg</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtool</span><span class="o">.</span><span class="n">fill_msg</span><span class="p">(</span><span class="s1">&#39;rq_error&#39;</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">dict</span><span class="p">(),</span>
                                               <span class="n">err_code</span><span class="o">=</span><span class="s1">&#39;experiment_status_incompatible&#39;</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">peer_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="o">.</span><span class="n">peers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;add peer - peer id in use!&quot;</span><span class="p">)</span>
            <span class="n">send_msg</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtool</span><span class="o">.</span><span class="n">fill_msg</span><span class="p">(</span><span class="s1">&#39;rq_error&#39;</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">dict</span><span class="p">(),</span>
                                               <span class="n">err_code</span><span class="o">=</span><span class="s1">&#39;peer_id_in_use&#39;</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;add peer - try extending config...&quot;</span><span class="p">)</span>
            <span class="n">_launching</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">supervisors</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="o">.</span><span class="n">peer_machines</span><span class="p">())</span>
            <span class="n">launch_file_parser</span><span class="o">.</span><span class="n">extend_experiment_config</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="p">,</span>
                <span class="n">peer_id</span><span class="p">,</span>
                <span class="n">message</span><span class="o">.</span><span class="n">peer_path</span><span class="p">,</span>
                <span class="n">config_sources</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">config_sources</span><span class="p">,</span>
                <span class="n">launch_deps</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">launch_dependencies</span><span class="p">,</span>
                <span class="n">custom_config_path</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">custom_config_path</span><span class="p">,</span>
                <span class="n">param_overwrites</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">param_overwrites</span><span class="p">,</span>
                <span class="n">machine</span><span class="o">=</span><span class="n">machine</span><span class="p">,</span>
                <span class="n">apply_globals</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">apply_globals</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;add peer - problem with extending config!&quot;</span><span class="p">)</span>
            <span class="n">send_msg</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtool</span><span class="o">.</span><span class="n">fill_msg</span><span class="p">(</span><span class="s1">&#39;rq_error&#39;</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">request</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">dict</span><span class="p">(),</span>
                                               <span class="n">err_code</span><span class="o">=</span><span class="s1">&#39;problem_with_extending_config&#39;</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;add peer - check config valid ...&quot;</span><span class="p">)</span>
            <span class="n">rd</span><span class="p">,</span> <span class="n">details</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="o">.</span><span class="n">config_ready</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">rd</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;add peer - config is valid!&quot;</span><span class="p">)</span>
                <span class="c1"># config is valid, we can proceed</span>
                <span class="n">send_msg</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtool</span><span class="o">.</span><span class="n">fill_msg</span><span class="p">(</span><span class="s1">&#39;rq_ok&#39;</span><span class="p">))</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">peers_status</span><span class="p">[</span><span class="n">peer_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">launcher_tools</span><span class="o">.</span><span class="n">PeerStatus</span><span class="p">(</span>
                    <span class="n">peer_id</span><span class="p">,</span> <span class="n">status_name</span><span class="o">=</span><span class="n">launcher_tools</span><span class="o">.</span><span class="n">READY_TO_LAUNCH</span><span class="p">)</span>

                <span class="n">ser</span> <span class="o">=</span> <span class="n">PeerConfigSerializerJSON</span><span class="p">()</span>
                <span class="n">bt</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
                <span class="n">ser</span><span class="o">.</span><span class="n">serialize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="o">.</span><span class="n">peers</span><span class="p">[</span><span class="n">peer_id</span><span class="p">]</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">bt</span><span class="p">)</span>
                <span class="n">peer_conf</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>

                <span class="c1"># broadcast message about scenario modification</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;add peer - bradcast scenario mods...&quot;</span><span class="p">)</span>
                <span class="n">send_msg</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_publish_socket</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mtool</span><span class="o">.</span><span class="n">fill_msg</span><span class="p">(</span>
                        <span class="s2">&quot;new_peer_added&quot;</span><span class="p">,</span>
                        <span class="n">peer_id</span><span class="o">=</span><span class="n">peer_id</span><span class="p">,</span>
                        <span class="n">machine</span><span class="o">=</span><span class="n">machine</span><span class="p">,</span>
                        <span class="n">uuid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                        <span class="n">status_name</span><span class="o">=</span><span class="n">launcher_tools</span><span class="o">.</span><span class="n">READY_TO_LAUNCH</span><span class="p">,</span>
                        <span class="n">config</span><span class="o">=</span><span class="n">peer_conf</span><span class="p">,</span>
                        <span class="n">peer_path</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">peer_path</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;add peer - config invalid!&quot;</span><span class="p">)</span>
                <span class="n">send_msg</span><span class="p">(</span>
                    <span class="n">sock</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mtool</span><span class="o">.</span><span class="n">fill_msg</span><span class="p">(</span>
                        <span class="s1">&#39;rq_error&#39;</span><span class="p">,</span>
                        <span class="n">err_code</span><span class="o">=</span><span class="s1">&#39;config_incomplete&#39;</span><span class="p">,</span>
                        <span class="n">details</span><span class="o">=</span><span class="n">details</span><span class="p">,</span>
                        <span class="n">request</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">dict</span><span class="p">()))</span>
                <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">status_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">launcher_tools</span><span class="o">.</span><span class="n">RUN_STATUSES</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;additional peers will launch along with base scenario&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># ...do actual work</span>
            <span class="k">if</span> <span class="n">machine</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">supervisors</span> <span class="ow">and</span> <span class="n">_launching</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;add peer - start supervisor on machine: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">machine</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_exp_extension</span> <span class="o">=</span> <span class="p">{</span><span class="n">machine</span><span class="p">:</span> <span class="p">[</span><span class="n">peer_id</span><span class="p">]}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_start_obci_process_supervisors</span><span class="p">([</span><span class="n">machine</span><span class="p">])</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">_launching</span><span class="p">:</span>
                <span class="c1"># the peer data will be sent to process supervisor in launch_data, so we do nothing</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;add peer - not _lauching, nothing else to do&quot;</span><span class="p">)</span>
                <span class="k">pass</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">peer_status</span><span class="p">(</span><span class="s1">&#39;mx&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">status_name</span> <span class="o">==</span> <span class="n">launcher_tools</span><span class="o">.</span><span class="n">RUNNING</span><span class="p">:</span>
                <span class="c1"># &#39;start_peers&#39; has been already sent so we additionally request for launching the</span>
                <span class="c1"># new peer</span>
                <span class="n">ldata</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">ldata</span><span class="p">[</span><span class="n">peer_id</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="o">.</span><span class="n">launch_data</span><span class="p">(</span><span class="n">machine</span><span class="p">)[</span><span class="n">peer_id</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;add peer - send start_peers...&quot;</span><span class="p">)</span>
                <span class="n">send_msg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_publish_socket</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtool</span><span class="o">.</span><span class="n">fill_msg</span><span class="p">(</span><span class="s2">&quot;start_peers&quot;</span><span class="p">,</span> <span class="n">mx_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mx_args</span><span class="p">(),</span>
                                                                   <span class="n">add_launch_data</span><span class="o">=</span><span class="p">{</span><span class="n">machine</span><span class="p">:</span> <span class="n">ldata</span><span class="p">}))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;add peer - last else, nothing else to do&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;add peer - ALL DONE!&quot;</span><span class="p">)</span></div>

    <span class="nd">@msg_handlers</span><span class="o">.</span><span class="n">handler</span><span class="p">(</span><span class="s2">&quot;kill_peer&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="OBCIExperiment.handle_kill_peer"><a class="viewcode-back" href="../../../../apidoc/obci.control.launcher.html#obci.control.launcher.obci_experiment.OBCIExperiment.handle_kill_peer">[docs]</a>    <span class="k">def</span> <span class="nf">handle_kill_peer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">sock</span><span class="p">):</span>
        <span class="n">peer_id</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">peer_id</span>
        <span class="n">peer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="o">.</span><span class="n">peers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">peer_id</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">peer</span><span class="p">:</span>
            <span class="n">send_msg</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtool</span><span class="o">.</span><span class="n">fill_msg</span><span class="p">(</span><span class="s1">&#39;rq_error&#39;</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">dict</span><span class="p">(),</span>
                                               <span class="n">err_code</span><span class="o">=</span><span class="s2">&quot;peer_id_not_found&quot;</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="o">.</span><span class="n">peers</span><span class="p">[</span><span class="n">peer_id</span><span class="p">]</span>
        <span class="n">rd</span><span class="p">,</span> <span class="n">details</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="o">.</span><span class="n">config_ready</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="o">.</span><span class="n">peers</span><span class="p">[</span><span class="n">peer_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">peer</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">rd</span><span class="p">:</span>
            <span class="n">send_msg</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtool</span><span class="o">.</span><span class="n">fill_msg</span><span class="p">(</span><span class="s1">&#39;rq_error&#39;</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">dict</span><span class="p">(),</span>
                                               <span class="n">err_code</span><span class="o">=</span><span class="s2">&quot;config_dependencies_error&quot;</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="n">details</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">message</span><span class="o">.</span><span class="n">remove_config</span><span class="p">:</span>
            <span class="n">peer</span><span class="o">.</span><span class="n">del_after_stop</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">send_msg</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtool</span><span class="o">.</span><span class="n">fill_msg</span><span class="p">(</span><span class="s2">&quot;rq_ok&quot;</span><span class="p">))</span>
        <span class="n">send_msg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_publish_socket</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtool</span><span class="o">.</span><span class="n">fill_msg</span><span class="p">(</span><span class="s2">&quot;_kill_peer&quot;</span><span class="p">,</span> <span class="n">peer_id</span><span class="o">=</span><span class="n">peer_id</span><span class="p">,</span>
                                                           <span class="n">machine</span><span class="o">=</span><span class="p">(</span><span class="n">peer</span><span class="o">.</span><span class="n">machine</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin_machine</span><span class="p">),</span> <span class="n">morph</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span></div>

    <span class="nd">@msg_handlers</span><span class="o">.</span><span class="n">handler</span><span class="p">(</span><span class="s2">&quot;obci_peer_registered&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="OBCIExperiment.handle_obci_peer_registered"><a class="viewcode-back" href="../../../../apidoc/obci.control.launcher.html#obci.control.launcher.obci_experiment.OBCIExperiment.handle_obci_peer_registered">[docs]</a>    <span class="k">def</span> <span class="nf">handle_obci_peer_registered</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">sock</span><span class="p">):</span>
        <span class="n">peer_id</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">peer_id</span>
        <span class="k">if</span> <span class="n">peer_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="o">.</span><span class="n">peers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Unknown Peer registered!!! </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">peer_id</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Peer registered!!! </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">peer_id</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">par</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">message</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="o">.</span><span class="n">update_local_param</span><span class="p">(</span><span class="n">peer_id</span><span class="p">,</span> <span class="n">par</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
            <span class="n">send_msg</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_publish_socket</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mtool</span><span class="o">.</span><span class="n">fill_msg</span><span class="p">(</span>
                    <span class="s1">&#39;obci_control_message&#39;</span><span class="p">,</span>
                    <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;info&#39;</span><span class="p">,</span>
                    <span class="n">msg_code</span><span class="o">=</span><span class="s1">&#39;obci_peer_registered&#39;</span><span class="p">,</span>
                    <span class="n">launcher_message</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">dict</span><span class="p">(),</span>
                    <span class="n">sender</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                    <span class="n">peer_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">peer_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">peer_type</span><span class="p">(),</span>
                    <span class="n">sender_ip</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">origin_machine</span><span class="p">))</span></div>

    <span class="nd">@msg_handlers</span><span class="o">.</span><span class="n">handler</span><span class="p">(</span><span class="s2">&quot;obci_peer_params_changed&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="OBCIExperiment.handle_obci_peer_params_changed"><a class="viewcode-back" href="../../../../apidoc/obci.control.launcher.html#obci.control.launcher.obci_experiment.OBCIExperiment.handle_obci_peer_params_changed">[docs]</a>    <span class="k">def</span> <span class="nf">handle_obci_peer_params_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">sock</span><span class="p">):</span>
        <span class="n">peer_id</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">peer_id</span>
        <span class="k">if</span> <span class="n">peer_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="o">.</span><span class="n">peers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Unknown Peer update!!! </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">peer_type</span><span class="p">(),</span> <span class="n">peer_id</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Params changed!!! </span><span class="si">{0}</span><span class="s2"> </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">peer_id</span><span class="p">,</span> <span class="n">message</span><span class="o">.</span><span class="n">params</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">par</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">message</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="o">.</span><span class="n">update_local_param</span><span class="p">(</span><span class="n">peer_id</span><span class="p">,</span> <span class="n">par</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Invalid params!!! </span><span class="si">{0}</span><span class="s2"> </span><span class="si">{1}</span><span class="s2"> </span><span class="si">{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">peer_id</span><span class="p">,</span>
                                                                             <span class="n">message</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>

            <span class="n">send_msg</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_publish_socket</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mtool</span><span class="o">.</span><span class="n">fill_msg</span><span class="p">(</span>
                    <span class="s1">&#39;obci_control_message&#39;</span><span class="p">,</span>
                    <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;info&#39;</span><span class="p">,</span>
                    <span class="n">msg_code</span><span class="o">=</span><span class="s1">&#39;obci_peer_params_changed&#39;</span><span class="p">,</span>
                    <span class="n">launcher_message</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">dict</span><span class="p">(),</span>
                    <span class="n">sender</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                    <span class="n">peer_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">peer_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">peer_type</span><span class="p">(),</span>
                    <span class="n">sender_ip</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">origin_machine</span><span class="p">))</span></div>

    <span class="nd">@msg_handlers</span><span class="o">.</span><span class="n">handler</span><span class="p">(</span><span class="s2">&quot;obci_peer_ready&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="OBCIExperiment.handle_obci_peer_ready"><a class="viewcode-back" href="../../../../apidoc/obci.control.launcher.html#obci.control.launcher.obci_experiment.OBCIExperiment.handle_obci_peer_ready">[docs]</a>    <span class="k">def</span> <span class="nf">handle_obci_peer_ready</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">sock</span><span class="p">):</span>
        <span class="n">peer_id</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">peer_id</span>
        <span class="k">if</span> <span class="n">peer_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="o">.</span><span class="n">peers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Unknown Peer update!!! </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">peer_id</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">peer_status</span><span class="p">(</span><span class="n">peer_id</span><span class="p">)</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span>
            <span class="n">launcher_tools</span><span class="o">.</span><span class="n">RUNNING</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ready_register</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> peer ready! </span><span class="si">{1}</span><span class="s2"> to go&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">peer_id</span><span class="p">,</span>
                                                            <span class="bp">self</span><span class="o">.</span><span class="n">_ready_register</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ready_register</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">launcher_tools</span><span class="o">.</span><span class="n">RUNNING</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">status_changed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">status_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">details</span><span class="p">,</span>
                            <span class="n">peers</span><span class="o">=</span><span class="p">{</span><span class="n">peer_id</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">peer_status</span><span class="p">(</span><span class="n">peer_id</span><span class="p">)</span><span class="o">.</span><span class="n">status_name</span><span class="p">})</span></div>


<span class="c1"># {&quot;status&quot;: [&quot;failed&quot;, null],</span>
<span class="c1"># &quot;sender&quot;: &quot;fb32da42-c8b6-47db-a958-249cd5e1f366&quot;,</span>
<span class="c1"># &quot;receiver&quot;: &quot;&quot;, &quot;sender_ip&quot;: &quot;127.0.0.1&quot;,</span>
<span class="c1"># &quot;path&quot;: &quot;/home/administrator/dev/openbci/acquisition/info_saver_peer.py&quot;,</span>
<span class="c1"># &quot;peer_id&quot;: &quot;info_saver&quot;, &quot;type&quot;: &quot;obci_peer_dead&quot;}</span>

    <span class="nd">@msg_handlers</span><span class="o">.</span><span class="n">handler</span><span class="p">(</span><span class="s1">&#39;obci_peer_dead&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="OBCIExperiment.handle_obci_peer_dead"><a class="viewcode-back" href="../../../../apidoc/obci.control.launcher.html#obci.control.launcher.obci_experiment.OBCIExperiment.handle_obci_peer_dead">[docs]</a>    <span class="k">def</span> <span class="nf">handle_obci_peer_dead</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">sock</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">message</span><span class="o">.</span><span class="n">peer_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="o">.</span><span class="n">peers</span><span class="p">:</span>
            <span class="c1"># during experiment transformation, &#39;obci_peer_dead&#39; messages may come</span>
            <span class="c1"># after explicitly terminating peers and removing them from experiment peers</span>
            <span class="c1"># configuration</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;peer_id&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">peer_id</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;not found!&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">details</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">peer_status</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">peer_id</span><span class="p">)</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="n">details</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="n">launcher_tools</span><span class="o">.</span><span class="n">FAILED</span><span class="p">:</span>
            <span class="n">send_msg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_publish_socket</span><span class="p">,</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">mtool</span><span class="o">.</span><span class="n">fill_msg</span><span class="p">(</span><span class="s2">&quot;stop_all&quot;</span><span class="p">,</span> <span class="n">receiver</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">launcher_tools</span><span class="o">.</span><span class="n">FAILED</span><span class="p">,</span>
                                   <span class="n">details</span><span class="o">=</span><span class="s1">&#39;Failed process &#39;</span> <span class="o">+</span> <span class="n">message</span><span class="o">.</span><span class="n">peer_id</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Experiment failed: (process: </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">message</span><span class="o">.</span><span class="n">peer_id</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">peer_status_exists</span><span class="p">(</span><span class="n">launcher_tools</span><span class="o">.</span><span class="n">RUNNING</span><span class="p">)</span> <span class="ow">and</span>\
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">status_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">launcher_tools</span><span class="o">.</span><span class="n">FAILED</span><span class="p">,</span> <span class="n">launcher_tools</span><span class="o">.</span><span class="n">FAILED_LAUNCH</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="o">.</span><span class="n">peers</span><span class="p">[</span><span class="n">message</span><span class="o">.</span><span class="n">peer_id</span><span class="p">]</span><span class="o">.</span><span class="n">del_after_stop</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="o">.</span><span class="n">peers</span><span class="p">[</span><span class="n">message</span><span class="o">.</span><span class="n">peer_id</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">del_peer_status</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">peer_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cfg_morph</span> <span class="ow">and</span> <span class="n">message</span><span class="o">.</span><span class="n">peer_id</span> <span class="o">==</span> <span class="s1">&#39;config_server&#39;</span> <span class="ow">and</span> <span class="n">status</span> <span class="o">==</span> <span class="n">launcher_tools</span><span class="o">.</span><span class="n">TERMINATED</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__cfg_morph</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">configs_to_restore</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kill_and_launch</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">send_msg</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_publish_socket</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mtool</span><span class="o">.</span><span class="n">fill_msg</span><span class="p">(</span>
                    <span class="s2">&quot;start_config_server&quot;</span><span class="p">,</span>
                    <span class="n">mx_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mx_args</span><span class="p">(),</span>
                    <span class="n">restore_config</span><span class="o">=</span><span class="n">configs_to_restore</span><span class="p">))</span>

        <span class="n">message</span><span class="o">.</span><span class="n">experiment_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uuid</span>
        <span class="n">send_msg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_publish_socket</span><span class="p">,</span> <span class="n">message</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_changed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">status_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">details</span><span class="p">)</span></div>

    <span class="nd">@msg_handlers</span><span class="o">.</span><span class="n">handler</span><span class="p">(</span><span class="s1">&#39;obci_launch_failed&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="OBCIExperiment.handle_obci_launch_failed"><a class="viewcode-back" href="../../../../apidoc/obci.control.launcher.html#obci.control.launcher.obci_experiment.OBCIExperiment.handle_obci_launch_failed">[docs]</a>    <span class="k">def</span> <span class="nf">handle_obci_launch_failed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">sock</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exp_extension</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;launch of additional peers failed&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_exp_extension</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">pass</span></div>

    <span class="nd">@msg_handlers</span><span class="o">.</span><span class="n">handler</span><span class="p">(</span><span class="s1">&#39;launch_error&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="OBCIExperiment.handle_launch_error"><a class="viewcode-back" href="../../../../apidoc/obci.control.launcher.html#obci.control.launcher.obci_experiment.OBCIExperiment.handle_launch_error">[docs]</a>    <span class="k">def</span> <span class="nf">handle_launch_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">sock</span><span class="p">):</span>
        <span class="n">peer_id</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">details</span><span class="p">[</span><span class="s2">&quot;peer_id&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">peer_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="o">.</span><span class="n">peers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;peer_id&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">peer_id</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;not found!&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">peer_status</span><span class="p">(</span><span class="n">peer_id</span><span class="p">)</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">launcher_tools</span><span class="o">.</span><span class="n">FAILED_LAUNCH</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">launcher_tools</span><span class="o">.</span><span class="n">FAILED_LAUNCH</span><span class="p">,</span>
                               <span class="n">details</span><span class="o">=</span><span class="s1">&#39;Failed to launch process &#39;</span> <span class="o">+</span> <span class="n">peer_id</span><span class="p">)</span>
        <span class="n">message</span><span class="o">.</span><span class="n">sender</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uuid</span>
        <span class="n">send_msg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_publish_socket</span><span class="p">,</span> <span class="n">message</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_changed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">status_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">details</span><span class="p">)</span></div>

    <span class="nd">@msg_handlers</span><span class="o">.</span><span class="n">handler</span><span class="p">(</span><span class="s1">&#39;update_peer_config&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="OBCIExperiment.handle_update_peer_config"><a class="viewcode-back" href="../../../../apidoc/obci.control.launcher.html#obci.control.launcher.obci_experiment.OBCIExperiment.handle_update_peer_config">[docs]</a>    <span class="k">def</span> <span class="nf">handle_update_peer_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">sock</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">status_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">launcher_tools</span><span class="o">.</span><span class="n">NOT_READY</span><span class="p">,</span>
                                           <span class="n">launcher_tools</span><span class="o">.</span><span class="n">READY_TO_LAUNCH</span><span class="p">]:</span>
            <span class="n">send_msg</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtool</span><span class="o">.</span><span class="n">fill_msg</span><span class="p">(</span><span class="s1">&#39;rq_error&#39;</span><span class="p">,</span> <span class="n">err_code</span><span class="o">=</span><span class="s1">&#39;update_not_possible&#39;</span><span class="p">,</span>
                                               <span class="n">details</span><span class="o">=</span><span class="s1">&#39;Experiment status: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">status_name</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">conf</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">local_params</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">local_params</span><span class="p">,</span>
                        <span class="n">external_params</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">external_params</span><span class="p">,</span>
                        <span class="n">launch_dependencies</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">launch_dependencies</span><span class="p">,</span>
                        <span class="n">config_sources</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">config_sources</span><span class="p">)</span>
            <span class="n">peer_id</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">peer_id</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="o">.</span><span class="n">update_peer_config</span><span class="p">(</span><span class="n">peer_id</span><span class="p">,</span> <span class="n">conf</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">send_msg</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtool</span><span class="o">.</span><span class="n">fill_msg</span><span class="p">(</span><span class="s1">&#39;rq_error&#39;</span><span class="p">,</span> <span class="n">err_code</span><span class="o">=</span><span class="s1">&#39;update_failed&#39;</span><span class="p">,</span>
                                                   <span class="n">details</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">send_msg</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtool</span><span class="o">.</span><span class="n">fill_msg</span><span class="p">(</span><span class="s1">&#39;rq_ok&#39;</span><span class="p">))</span></div>

    <span class="nd">@msg_handlers</span><span class="o">.</span><span class="n">handler</span><span class="p">(</span><span class="s2">&quot;dead_process&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="OBCIExperiment.handle_dead_process"><a class="viewcode-back" href="../../../../apidoc/obci.control.launcher.html#obci.control.launcher.obci_experiment.OBCIExperiment.handle_dead_process">[docs]</a>    <span class="k">def</span> <span class="nf">handle_dead_process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">sock</span><span class="p">):</span>
        <span class="n">proc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subprocess_mgr</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">machine</span><span class="p">,</span> <span class="n">message</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">proc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">proc</span><span class="o">.</span><span class="n">mark_delete</span><span class="p">()</span>
            <span class="n">status</span><span class="p">,</span> <span class="n">details</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">status</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Process &quot;</span> <span class="o">+</span> <span class="n">proc</span><span class="o">.</span><span class="n">proc_type</span> <span class="o">+</span> <span class="s2">&quot;dead:&quot;</span> <span class="o">+</span>
                                <span class="n">status</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">details</span><span class="p">)</span> <span class="o">+</span> <span class="n">proc</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">proc</span><span class="o">.</span><span class="n">pid</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">proc</span><span class="o">.</span><span class="n">proc_type</span> <span class="o">==</span> <span class="s1">&#39;obci_process_supervisor&#39;</span><span class="p">:</span>
                <span class="n">send_msg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_publish_socket</span><span class="p">,</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">mtool</span><span class="o">.</span><span class="n">fill_msg</span><span class="p">(</span><span class="s2">&quot;stop_all&quot;</span><span class="p">,</span> <span class="n">receiver</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">launcher_tools</span><span class="o">.</span><span class="n">FAILED</span><span class="p">,</span>
                                       <span class="n">details</span><span class="o">=</span><span class="s1">&#39;Failed LAUNCHER component obci_process_supervisor&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">proc</span><span class="o">.</span><span class="n">proc_type</span> <span class="o">==</span> <span class="s1">&#39;obci_experiment&#39;</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="n">subprocess_monitor</span><span class="o">.</span><span class="n">FAILED</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_changed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">status_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">details</span><span class="p">)</span></div>

    <span class="nd">@msg_handlers</span><span class="o">.</span><span class="n">handler</span><span class="p">(</span><span class="s1">&#39;save_scenario&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="OBCIExperiment.handle_save_scenario"><a class="viewcode-back" href="../../../../apidoc/obci.control.launcher.html#obci.control.launcher.obci_experiment.OBCIExperiment.handle_save_scenario">[docs]</a>    <span class="k">def</span> <span class="nf">handle_save_scenario</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">sock</span><span class="p">):</span>
        <span class="n">send_msg</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtool</span><span class="o">.</span><span class="n">fill_msg</span><span class="p">(</span><span class="s1">&#39;rq_error&#39;</span><span class="p">,</span> <span class="n">err_code</span><span class="o">=</span><span class="s1">&#39;action_not_supported&#39;</span><span class="p">))</span></div>

    <span class="nd">@msg_handlers</span><span class="o">.</span><span class="n">handler</span><span class="p">(</span><span class="s1">&#39;nearby_machines&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="OBCIExperiment.handle_nearby_machines"><a class="viewcode-back" href="../../../../apidoc/obci.control.launcher.html#obci.control.launcher.obci_experiment.OBCIExperiment.handle_nearby_machines">[docs]</a>    <span class="k">def</span> <span class="nf">handle_nearby_machines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">sock</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nearby_machines</span><span class="o">.</span><span class="n">mass_update</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">nearby_machines</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">current_ip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nearby_machines</span><span class="o">.</span><span class="n">this_addr_network</span><span class="p">()</span>

        <span class="n">send_msg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_publish_socket</span><span class="p">,</span> <span class="n">message</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">())</span></div>

    <span class="nd">@msg_handlers</span><span class="o">.</span><span class="n">handler</span><span class="p">(</span><span class="s2">&quot;experiment_finished&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="OBCIExperiment.handle_experiment_finished"><a class="viewcode-back" href="../../../../apidoc/obci.control.launcher.html#obci.control.launcher.obci_experiment.OBCIExperiment.handle_experiment_finished">[docs]</a>    <span class="k">def</span> <span class="nf">handle_experiment_finished</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">sock</span><span class="p">):</span>
        <span class="c1"># [make mx_messsage]</span>
        <span class="c1"># [handler in config_server]</span>
        <span class="c1"># stop_all</span>
        <span class="c1"># status - finished</span>
        <span class="k">pass</span></div>

    <span class="nd">@msg_handlers</span><span class="o">.</span><span class="n">handler</span><span class="p">(</span><span class="s2">&quot;morph_to_new_scenario&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="OBCIExperiment.handle_morph"><a class="viewcode-back" href="../../../../apidoc/obci.control.launcher.html#obci.control.launcher.obci_experiment.OBCIExperiment.handle_morph">[docs]</a>    <span class="k">def</span> <span class="nf">handle_morph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">sock</span><span class="p">):</span>
        <span class="c1"># FIXME &quot;LAUNCHING&quot; -- msg bug workaround</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">status_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">launcher_tools</span><span class="o">.</span><span class="n">RUNNING</span><span class="p">,</span> <span class="n">launcher_tools</span><span class="o">.</span><span class="n">LAUNCHING</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;EXPERIMENT STATUS NOT RUNNING, MORPH NOT ALLOWED&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sock</span><span class="o">.</span><span class="n">getsockopt</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">TYPE</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="n">zmq</span><span class="o">.</span><span class="n">REQ</span><span class="p">,</span> <span class="n">zmq</span><span class="o">.</span><span class="n">ROUTER</span><span class="p">]:</span>

                <span class="n">send_msg</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtool</span><span class="o">.</span><span class="n">fill_msg</span><span class="p">(</span><span class="s1">&#39;rq_error&#39;</span><span class="p">,</span>
                                                   <span class="n">err_code</span><span class="o">=</span><span class="s1">&#39;experiment_not_running&#39;</span><span class="p">,</span>
                                                   <span class="n">details</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">details</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="n">new_launch_file</span> <span class="o">=</span> <span class="n">launcher_tools</span><span class="o">.</span><span class="n">obci_root_relative</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">launch_file</span><span class="p">)</span>
        <span class="n">exp_config</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_experiment_config</span><span class="p">(</span><span class="n">new_launch_file</span><span class="p">,</span>
                                                                <span class="n">message</span><span class="o">.</span><span class="n">overwrites</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;new launch status </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">exp_config</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">status</span><span class="o">.</span><span class="n">status_name</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">status</span><span class="o">.</span><span class="n">status_name</span> <span class="o">!=</span> <span class="n">launcher_tools</span><span class="o">.</span><span class="n">READY_TO_LAUNCH</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;NEW SCENARIO NOT READY TO LAUNCH, MOPRH NOT ALLOWED&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sock</span><span class="o">.</span><span class="n">getsockopt</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">TYPE</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="n">zmq</span><span class="o">.</span><span class="n">REQ</span><span class="p">,</span> <span class="n">zmq</span><span class="o">.</span><span class="n">ROUTER</span><span class="p">]:</span>

                <span class="n">send_msg</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtool</span><span class="o">.</span><span class="n">fill_msg</span><span class="p">(</span><span class="s1">&#39;rq_error&#39;</span><span class="p">,</span>
                                                   <span class="n">err_code</span><span class="o">=</span><span class="s1">&#39;launch_file_invalid&#39;</span><span class="p">,</span>
                                                   <span class="n">details</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">status_name</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">status_name</span><span class="p">,</span>
                                                                <span class="n">details</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">details</span><span class="p">)))</span>
            <span class="k">return</span>

        <span class="n">valid</span><span class="p">,</span> <span class="n">details</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_morph_leave_on</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="p">,</span> <span class="n">exp_config</span><span class="p">,</span> <span class="n">message</span><span class="o">.</span><span class="n">leave_on</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;morph valid: </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">valid</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">details</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">valid</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sock</span><span class="o">.</span><span class="n">getsockopt</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">TYPE</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="n">zmq</span><span class="o">.</span><span class="n">REQ</span><span class="p">,</span> <span class="n">zmq</span><span class="o">.</span><span class="n">ROUTER</span><span class="p">]:</span>
                <span class="n">send_msg</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtool</span><span class="o">.</span><span class="n">fill_msg</span><span class="p">(</span><span class="s1">&#39;rq_error&#39;</span><span class="p">,</span>
                                                   <span class="n">err_code</span><span class="o">=</span><span class="s1">&#39;leave_on_peers_invalid&#39;</span><span class="p">,</span>
                                                   <span class="n">details</span><span class="o">=</span><span class="n">details</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="n">kill_list</span><span class="p">,</span> <span class="n">launch_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_diff_scenarios</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="p">,</span>
                                                      <span class="n">exp_config</span><span class="p">,</span> <span class="n">message</span><span class="o">.</span><span class="n">leave_on</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;KILL_LIST &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">kill_list</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;LAUNCH_LIST&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">launch_list</span><span class="p">))</span>

        <span class="n">old_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="n">old_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="n">message</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">new_launch_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">launch_file</span> <span class="o">=</span> <span class="n">new_launch_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span>

        <span class="n">old_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span> <span class="o">=</span> <span class="n">exp_config</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">message</span><span class="o">.</span><span class="n">leave_on</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="o">.</span><span class="n">peers</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_config</span><span class="o">.</span><span class="n">peers</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">sock</span><span class="o">.</span><span class="n">getsockopt</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">TYPE</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="n">zmq</span><span class="o">.</span><span class="n">REP</span><span class="p">,</span> <span class="n">zmq</span><span class="o">.</span><span class="n">ROUTER</span><span class="p">]:</span>
            <span class="n">send_msg</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtool</span><span class="o">.</span><span class="n">fill_msg</span><span class="p">(</span><span class="s1">&#39;starting_experiment&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">launcher_tools</span><span class="o">.</span><span class="n">LAUNCHING</span><span class="p">)</span>
            <span class="n">send_msg</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">source_req_socket</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mtool</span><span class="o">.</span><span class="n">fill_msg</span><span class="p">(</span>
                    <span class="s1">&#39;experiment_transformation&#39;</span><span class="p">,</span>
                    <span class="n">status_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">status_name</span><span class="p">,</span>
                    <span class="n">details</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">details</span><span class="p">,</span>
                    <span class="n">uuid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">launch_file</span><span class="o">=</span><span class="n">new_launch_file</span><span class="p">,</span>
                    <span class="n">old_name</span><span class="o">=</span><span class="n">old_name</span><span class="p">,</span>
                    <span class="n">old_launch_file</span><span class="o">=</span><span class="n">old_config</span><span class="o">.</span><span class="n">launch_file_path</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">poller</span><span class="o">.</span><span class="n">poll_recv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_req_socket</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">8000</span><span class="p">)</span>

        <span class="c1"># TODO -- notice obci_server of name/config change</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_kill_and_launch_peers</span><span class="p">(</span><span class="n">kill_list</span><span class="p">,</span> <span class="n">launch_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="p">,</span> <span class="n">old_config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_kill_unused_supervisors</span><span class="p">()</span>

        <span class="n">pst</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">peer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">peers_status</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">peer</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">launch_list</span> <span class="ow">and</span> <span class="n">peer</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kill_list</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">peer_status</span><span class="p">(</span><span class="n">peer</span><span class="p">)</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">old_status</span><span class="o">.</span><span class="n">peer_status</span><span class="p">(</span><span class="n">peer</span><span class="p">)</span><span class="o">.</span><span class="n">status_name</span><span class="p">,</span>
                                                         <span class="n">old_status</span><span class="o">.</span><span class="n">peer_status</span><span class="p">(</span><span class="n">peer</span><span class="p">)</span><span class="o">.</span><span class="n">details</span><span class="p">)</span>

                <span class="n">pst</span><span class="p">[</span><span class="n">peer</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">peer_status</span><span class="p">(</span><span class="n">peer</span><span class="p">)</span><span class="o">.</span><span class="n">status_name</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">status_changed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">status_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">details</span><span class="p">,</span>
                            <span class="n">peers</span><span class="o">=</span><span class="n">pst</span><span class="p">)</span></div>

        <span class="c1"># list: to kill, to restart (unless in leave-on)</span>
        <span class="c1"># start supervisors if new machnes specified</span>
        <span class="c1"># send launch_data to all</span>
        <span class="c1"># start</span>
        <span class="c1"># deregister / register in obci_server</span>

    <span class="k">def</span> <span class="nf">_kill_and_launch_peers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kill_list</span><span class="p">,</span> <span class="n">launch_list</span><span class="p">,</span> <span class="n">new_config</span><span class="p">,</span> <span class="n">old_config</span><span class="p">):</span>
        <span class="n">kill_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">peer</span> <span class="ow">in</span> <span class="n">kill_list</span><span class="p">:</span>
            <span class="n">machine</span> <span class="o">=</span> <span class="n">old_config</span><span class="o">.</span><span class="n">peers</span><span class="p">[</span><span class="n">peer</span><span class="p">]</span><span class="o">.</span><span class="n">machine</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">machine</span><span class="p">:</span>
                <span class="n">machine</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin_machine</span>
            <span class="k">if</span> <span class="n">machine</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kill_data</span><span class="p">:</span>
                <span class="n">kill_data</span><span class="p">[</span><span class="n">machine</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">kill_data</span><span class="p">[</span><span class="n">machine</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">peer</span><span class="p">)</span>

        <span class="n">launch_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ready_register</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">machine</span> <span class="ow">in</span> <span class="n">new_config</span><span class="o">.</span><span class="n">peer_machines</span><span class="p">():</span>
            <span class="n">ldata</span> <span class="o">=</span> <span class="n">new_config</span><span class="o">.</span><span class="n">launch_data</span><span class="p">(</span><span class="n">machine</span><span class="p">)</span>
            <span class="n">peers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ldata</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">peer</span> <span class="ow">in</span> <span class="n">peers</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">peer</span> <span class="ow">in</span> <span class="n">launch_list</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">machine</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">launch_data</span><span class="p">:</span>
                        <span class="n">launch_data</span><span class="p">[</span><span class="n">machine</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">launch_data</span><span class="p">[</span><span class="n">machine</span><span class="p">][</span><span class="n">peer</span><span class="p">]</span> <span class="o">=</span> <span class="n">ldata</span><span class="p">[</span><span class="n">peer</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_ready_register</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">new_supervisors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">machine</span> <span class="ow">in</span> <span class="n">launch_data</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">machine</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">old_config</span><span class="o">.</span><span class="n">peer_machines</span><span class="p">():</span>
                <span class="n">new_supervisors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">machine</span><span class="p">)</span>

        <span class="n">keep_configs</span> <span class="o">=</span> <span class="p">[</span><span class="n">peer</span> <span class="k">for</span> <span class="n">peer</span> <span class="ow">in</span> <span class="n">old_config</span><span class="o">.</span><span class="n">peers</span> <span class="k">if</span> <span class="n">peer</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kill_list</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_kill_and_launch</span> <span class="o">=</span> <span class="p">(</span><span class="n">kill_data</span><span class="p">,</span> <span class="n">launch_data</span><span class="p">,</span> <span class="n">new_supervisors</span><span class="p">,</span> <span class="n">keep_configs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">new_supervisors</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_wait_register</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_supervisors</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_start_obci_process_supervisors</span><span class="p">(</span><span class="n">new_supervisors</span><span class="p">)</span>
<span class="c1"># --------------------------------------------------------------------------------------</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__cfg_morph</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">send_msg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_publish_socket</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtool</span><span class="o">.</span><span class="n">fill_msg</span><span class="p">(</span><span class="s2">&quot;_kill_peer&quot;</span><span class="p">,</span> <span class="n">peer_id</span><span class="o">=</span><span class="s2">&quot;config_server&quot;</span><span class="p">,</span> <span class="n">morph</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_kill_unused_supervisors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_diff_scenarios</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_config</span><span class="p">,</span> <span class="n">new_config</span><span class="p">,</span> <span class="n">leave_on</span><span class="p">):</span>
        <span class="n">kill_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">peer</span> <span class="ow">in</span> <span class="n">old_config</span><span class="o">.</span><span class="n">peers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">peer</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">new_config</span><span class="o">.</span><span class="n">peers</span><span class="p">:</span>
                <span class="n">kill_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">peer</span><span class="p">)</span>
        <span class="n">launch_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">peer</span> <span class="ow">in</span> <span class="n">new_config</span><span class="o">.</span><span class="n">peers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">peer</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">old_config</span><span class="o">.</span><span class="n">peers</span><span class="p">:</span>
                <span class="n">launch_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">peer</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">peer</span> <span class="ow">in</span> <span class="n">new_config</span><span class="o">.</span><span class="n">peers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">peer</span> <span class="ow">in</span> <span class="n">old_config</span><span class="o">.</span><span class="n">peers</span> <span class="ow">and</span> <span class="n">peer</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">leave_on</span> <span class="ow">and</span> \
                    <span class="n">peer</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;mx&#39;</span><span class="p">,</span> <span class="s1">&#39;config_server&#39;</span><span class="p">]:</span>
                <span class="n">kill_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">peer</span><span class="p">)</span>
                <span class="n">launch_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">peer</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">kill_list</span><span class="p">,</span> <span class="n">launch_list</span>

    <span class="k">def</span> <span class="nf">_validate_morph_leave_on</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_config</span><span class="p">,</span> <span class="n">new_config</span><span class="p">,</span> <span class="n">leave_on</span><span class="p">):</span>

        <span class="k">for</span> <span class="n">peer_id</span> <span class="ow">in</span> <span class="n">leave_on</span><span class="p">:</span>

            <span class="n">old_p</span> <span class="o">=</span> <span class="n">old_config</span><span class="o">.</span><span class="n">peers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">peer_id</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">new_p</span> <span class="o">=</span> <span class="n">new_config</span><span class="o">.</span><span class="n">peers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">peer_id</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">old_p</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">new_p</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Peer id &quot;</span> <span class="o">+</span> <span class="n">peer_id</span> <span class="o">+</span> <span class="s1">&#39;present old config: &#39;</span> \
                    <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">old_p</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;, present in new config: &#39;</span> <span class="o">+</span>\
                    <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">new_p</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">old_p</span><span class="o">.</span><span class="n">path</span> <span class="o">!=</span> <span class="n">new_p</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Peer ids [&quot;</span> <span class="o">+</span> <span class="n">peer_id</span> <span class="o">+</span> <span class="s2">&quot;] point to different programs: &quot;</span> <span class="o">+</span>\
                    <span class="s2">&quot;old: &quot;</span> <span class="o">+</span> <span class="n">old_p</span><span class="o">.</span><span class="n">path</span> <span class="o">+</span> <span class="s1">&#39;, new: &#39;</span> <span class="o">+</span> <span class="n">new_p</span><span class="o">.</span><span class="n">path</span>

            <span class="n">old_machine</span> <span class="o">=</span> <span class="n">old_p</span><span class="o">.</span><span class="n">machine</span> <span class="k">if</span> <span class="n">old_p</span><span class="o">.</span><span class="n">machine</span> <span class="k">else</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span>
            <span class="n">new_machine</span> <span class="o">=</span> <span class="n">new_p</span><span class="o">.</span><span class="n">machine</span> <span class="k">if</span> <span class="n">new_p</span><span class="o">.</span><span class="n">machine</span> <span class="k">else</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">old_machine</span> <span class="o">!=</span> <span class="n">new_machine</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Peer id &quot;</span> <span class="o">+</span> <span class="n">peer_id</span> <span class="o">+</span> <span class="s1">&#39;is to be launched on a different machine: &#39;</span> <span class="o">+</span>\
                    <span class="s2">&quot;old: &quot;</span> <span class="o">+</span> <span class="n">old_machine</span> <span class="o">+</span> <span class="s1">&#39;, new:&#39;</span> <span class="o">+</span> <span class="n">new_machine</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>

<div class="viewcode-block" id="OBCIExperiment.cleanup_before_net_shutdown"><a class="viewcode-back" href="../../../../apidoc/obci.control.launcher.html#obci.control.launcher.obci_experiment.OBCIExperiment.cleanup_before_net_shutdown">[docs]</a>    <span class="k">def</span> <span class="nf">cleanup_before_net_shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kill_message</span><span class="p">,</span> <span class="n">sock</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="n">send_msg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_publish_socket</span><span class="p">,</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">mtool</span><span class="o">.</span><span class="n">fill_msg</span><span class="p">(</span><span class="s2">&quot;kill&quot;</span><span class="p">,</span> <span class="n">receiver</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">sender</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uuid</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;sent KILL to supervisors&#39;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">OBCIExperiment</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">cleanup_before_net_shutdown</span><span class="p">(</span><span class="n">kill_message</span><span class="p">,</span> <span class="n">sock</span><span class="p">)</span></div>

<div class="viewcode-block" id="OBCIExperiment.clean_up"><a class="viewcode-back" href="../../../../apidoc/obci.control.launcher.html#obci.control.launcher.obci_experiment.OBCIExperiment.clean_up">[docs]</a>    <span class="k">def</span> <span class="nf">clean_up</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;exp cleaning up&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subprocess_mgr</span><span class="o">.</span><span class="n">stop_monitoring</span><span class="p">()</span></div>
        <span class="c1"># self._tcp_srv.shutdown()</span>

    <span class="k">def</span> <span class="nf">_handle_register_sv_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sv_process</span><span class="p">):</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="s2">&quot;Supervisor for machine </span><span class="si">{0}</span><span class="s2"> FAILED TO REGISTER before timeout&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">sv_process</span><span class="o">.</span><span class="n">machine_ip</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>

        <span class="n">sock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_push_sock</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_push_addr</span><span class="p">)</span>

        <span class="c1"># inform observers about failure</span>
        <span class="n">send_msg</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtool</span><span class="o">.</span><span class="n">fill_msg</span><span class="p">(</span><span class="s2">&quot;experiment_launch_error&quot;</span><span class="p">,</span>
                                           <span class="n">sender</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                           <span class="n">err_code</span><span class="o">=</span><span class="s2">&quot;create_supervisor_error&quot;</span><span class="p">,</span>
                                           <span class="n">details</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">machine</span><span class="o">=</span><span class="n">sv_process</span><span class="o">.</span><span class="n">machine_ip</span><span class="p">,</span>
                                                        <span class="n">error</span><span class="o">=</span><span class="n">txt</span><span class="p">)))</span>
        <span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="nd">@msg_handlers</span><span class="o">.</span><span class="n">handler</span><span class="p">(</span><span class="s2">&quot;get_tail&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="OBCIExperiment.handle_get_tail"><a class="viewcode-back" href="../../../../apidoc/obci.control.launcher.html#obci.control.launcher.obci_experiment.OBCIExperiment.handle_get_tail">[docs]</a>    <span class="k">def</span> <span class="nf">handle_get_tail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">sock</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">status_name</span> <span class="o">==</span> <span class="n">launcher_tools</span><span class="o">.</span><span class="n">RUNNING</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">message</span><span class="o">.</span><span class="n">peer_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="o">.</span><span class="n">peers</span><span class="p">:</span>
                <span class="n">send_msg</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtool</span><span class="o">.</span><span class="n">fill_msg</span><span class="p">(</span><span class="s2">&quot;rq_error&quot;</span><span class="p">,</span>
                                                   <span class="n">err_code</span><span class="o">=</span><span class="s2">&quot;peer_not_found&quot;</span><span class="p">,</span>
                                                   <span class="n">details</span><span class="o">=</span><span class="s2">&quot;No such peer: &quot;</span> <span class="o">+</span> <span class="n">message</span><span class="o">.</span><span class="n">peer_id</span><span class="p">))</span>
                <span class="k">return</span>
            <span class="n">machine</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="o">.</span><span class="n">peer_machine</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">peer_id</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;getting tail for </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">message</span><span class="o">.</span><span class="n">peer_id</span><span class="p">,</span> <span class="n">machine</span><span class="p">)</span>
            <span class="n">send_msg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_publish_socket</span><span class="p">,</span> <span class="n">message</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client_rq</span> <span class="o">=</span> <span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">sock</span><span class="p">)</span></div>

    <span class="nd">@msg_handlers</span><span class="o">.</span><span class="n">handler</span><span class="p">(</span><span class="s2">&quot;tail&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="OBCIExperiment.handle_tail"><a class="viewcode-back" href="../../../../apidoc/obci.control.launcher.html#obci.control.launcher.obci_experiment.OBCIExperiment.handle_tail">[docs]</a>    <span class="k">def</span> <span class="nf">handle_tail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">sock</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_rq</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">message</span><span class="o">.</span><span class="n">peer_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_rq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">peer_id</span><span class="p">:</span>
                <span class="n">send_msg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client_rq</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">message</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">())</span></div>

    <span class="k">def</span> <span class="nf">_crash_extra_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exception</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">json</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">OBCIExperiment</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_crash_extra_data</span><span class="p">(</span><span class="n">exception</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
            <span class="s1">&#39;experiment_uuid&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
            <span class="s1">&#39;launch_file_path&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">launch_file</span><span class="p">,</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s1">&#39;config&#39;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">serialize_scenario_json</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="p">))</span>
        <span class="p">})</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">_crash_extra_tags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exception</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">OBCIExperiment</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_crash_extra_tags</span><span class="p">(</span><span class="n">exception</span><span class="p">)</span>
        <span class="n">tags</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
            <span class="s1">&#39;experiment_uuid&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">uuid</span>

        <span class="p">})</span>
        <span class="k">return</span> <span class="n">tags</span></div>


<div class="viewcode-block" id="experiment_arg_parser"><a class="viewcode-back" href="../../../../apidoc/obci.control.launcher.html#obci.control.launcher.obci_experiment.experiment_arg_parser">[docs]</a><span class="k">def</span> <span class="nf">experiment_arg_parser</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="p">[</span><span class="n">basic_arg_parser</span><span class="p">()],</span>
                                     <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Create, launch and manage an OBCI experiment.&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--sv-pub-addresses&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Addresses of the PUB socket of the supervisor&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--sandbox-dir&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Directory to store temporary and log files&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--launch-file&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Experiment launch file&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--name&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;obci_experiment&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Human readable name of this process&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--launch&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Launch the experiment specified in launch file&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--current-ip&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;IP addr of host machine&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--ovr&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">REMAINDER</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">parser</span></div>


<div class="viewcode-block" id="run_obci_experiment"><a class="viewcode-back" href="../../../../apidoc/obci.control.launcher.html#obci.control.launcher.obci_experiment.run_obci_experiment">[docs]</a><span class="k">def</span> <span class="nf">run_obci_experiment</span><span class="p">():</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">experiment_arg_parser</span><span class="p">()</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">pack</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">ovr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pack</span> <span class="o">=</span> <span class="n">peer_cmd</span><span class="o">.</span><span class="n">peer_overwrites_pack</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">ovr</span><span class="p">)</span>
    <span class="n">exp</span> <span class="o">=</span> <span class="n">OBCIExperiment</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">sandbox_dir</span><span class="p">,</span>
                         <span class="n">args</span><span class="o">.</span><span class="n">launch_file</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">sv_addresses</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">sv_pub_addresses</span><span class="p">,</span>
                         <span class="n">args</span><span class="o">.</span><span class="n">rep_addresses</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">pub_addresses</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                         <span class="n">args</span><span class="o">.</span><span class="n">current_ip</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">launch</span><span class="p">,</span> <span class="n">overwrites</span><span class="o">=</span><span class="n">pack</span><span class="p">)</span>
    <span class="n">exp</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../index.html">openbci</a></h1>



<p class="blurb">OpenBCI 2 framework</p>






<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../apidoc/modules.html">obci</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../index.html">Documentation overview</a><ul>
  <li><a href="../../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2016, Alex Khrabrov.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.4.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.9</a>
      
    </div>

    

    
  </body>
</html>